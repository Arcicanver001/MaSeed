<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Greenhouse Dashboard</title>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- MQTT.js for broker connection -->
    <script src="https://unpkg.com/mqtt@5.3.0/dist/mqtt.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- App JavaScript -->
    <script src="js/app.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/mqtt.js"></script>
    <script src="js/ui.js"></script>
    
    <!-- Early function definitions for button onclick handlers -->
    <script>
        // Define complete toggleFan function immediately so onclick handlers can access it
        // Initialize state variables
        window.fanState = false;
        window.humidifierState = false;
        window.sprinklerState = false;
        
        // Define complete toggleFan function that works immediately
        window.toggleFan = function() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üéØüéØüéØ FAN BUTTON CLICKED - FUNCTION CALLED! üéØüéØüéØ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Get button element
            const buttonElement = document.getElementById('fanButton');
            if (!buttonElement) {
                console.error('‚ùå Fan button element not found!');
                return;
            }
            
            // Visual feedback
            const originalBorder = buttonElement.style.border;
            buttonElement.style.border = '5px solid #ff0000';
            buttonElement.style.backgroundColor = '#ffebee';
            setTimeout(() => {
                buttonElement.style.border = originalBorder;
                buttonElement.style.backgroundColor = '';
            }, 300);
            
            // Toggle state
            window.fanState = !window.fanState;
            const fanState = window.fanState;
            
            // Update UI
            const statusElement = document.getElementById('fanStatus');
            const powerElement = document.getElementById('fanPower');
            const timeElement = document.getElementById('fanTime');
            const indicatorElement = document.getElementById('fanIndicator');
            
            if (statusElement && powerElement && timeElement) {
                if (fanState) {
                    buttonElement.classList.add('active');
                    if (indicatorElement) indicatorElement.classList.add('active');
                    buttonElement.style.borderColor = '#28a745';
                    statusElement.textContent = 'ON';
                    statusElement.style.color = '#28a745';
                    statusElement.style.fontSize = '1.5rem';
                    statusElement.style.fontWeight = 'bold';
                    powerElement.textContent = '250W';
                    timeElement.textContent = new Date().toLocaleTimeString();
                } else {
                    buttonElement.classList.remove('active');
                    if (indicatorElement) indicatorElement.classList.remove('active');
                    buttonElement.style.borderColor = '#dc3545';
                    statusElement.textContent = 'OFF';
                    statusElement.style.color = '#dc3545';
                    statusElement.style.fontSize = '1.5rem';
                    statusElement.style.fontWeight = 'bold';
                    powerElement.textContent = '0W';
                    timeElement.textContent = 'Ready';
                }
            }
            
            // Force manual override by turning auto mode OFF
            if (typeof sendAutoMode === 'function') {
                sendAutoMode(false);
            }
            
            // Send MQTT command
            const command = fanState ? 'ON' : 'OFF';
            const topic = 'greenhouse/actuators/fan';
            const mqttClient = window.mqttClient;
            
            console.log('üì° Sending MQTT command:', { topic, command });
            
            if (mqttClient && mqttClient.connected) {
                try {
                    mqttClient.publish(topic, command, { qos: 1 });
                    console.log('‚úÖ MQTT command sent:', command);
                } catch (error) {
                    console.error('‚ùå MQTT Error:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è MQTT not connected');
            }
        };
        
        // Define complete toggleHumidifier function
        window.toggleHumidifier = function() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üéØüéØüéØ HUMIDIFIER BUTTON CLICKED - FUNCTION CALLED! üéØüéØüéØ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Get button element
            const buttonElement = document.getElementById('humidifierButton');
            if (!buttonElement) {
                console.error('‚ùå Humidifier button element not found!');
                return;
            }
            
            // Visual feedback
            const originalBorder = buttonElement.style.border;
            buttonElement.style.border = '5px solid #ff0000';
            buttonElement.style.backgroundColor = '#ffebee';
            setTimeout(() => {
                buttonElement.style.border = originalBorder;
                buttonElement.style.backgroundColor = '';
            }, 300);
            
            // Toggle state
            window.humidifierState = !window.humidifierState;
            const humidifierState = window.humidifierState;
            
            // Update UI
            const statusElement = document.getElementById('humidifierStatus');
            const powerElement = document.getElementById('humidifierPower');
            const timeElement = document.getElementById('humidifierTime');
            const indicatorElement = document.getElementById('humidifierIndicator');
            
            if (statusElement && powerElement && timeElement) {
                if (humidifierState) {
                    buttonElement.classList.add('active');
                    if (indicatorElement) indicatorElement.classList.add('active');
                    buttonElement.style.borderColor = '#28a745';
                    statusElement.textContent = 'ON';
                    statusElement.style.color = '#28a745';
                    statusElement.style.fontSize = '1.5rem';
                    statusElement.style.fontWeight = 'bold';
                    powerElement.textContent = '150W';
                    timeElement.textContent = new Date().toLocaleTimeString();
                } else {
                    buttonElement.classList.remove('active');
                    if (indicatorElement) indicatorElement.classList.remove('active');
                    buttonElement.style.borderColor = '#dc3545';
                    statusElement.textContent = 'OFF';
                    statusElement.style.color = '#dc3545';
                    statusElement.style.fontSize = '1.5rem';
                    statusElement.style.fontWeight = 'bold';
                    powerElement.textContent = '0W';
                    timeElement.textContent = 'Ready';
                }
            }
            
            // Force manual override by turning auto mode OFF
            if (typeof sendAutoMode === 'function') {
                sendAutoMode(false);
            }
            
            // Send MQTT command
            const command = humidifierState ? 'ON' : 'OFF';
            const topic = 'greenhouse/actuators/humidifier';
            const mqttClient = window.mqttClient;
            
            console.log('üì° Sending MQTT command:', { topic, command });
            
            if (mqttClient && mqttClient.connected) {
                try {
                    mqttClient.publish(topic, command, { qos: 1 });
                    console.log('‚úÖ MQTT command sent:', command);
                } catch (error) {
                    console.error('‚ùå MQTT Error:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è MQTT not connected');
            }
        };
        
        // Define complete toggleSprinkler function
        window.toggleSprinkler = function() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üéØüéØüéØ SPRINKLER BUTTON CLICKED - FUNCTION CALLED! üéØüéØüéØ');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Get button element
            const buttonElement = document.getElementById('sprinklerButton');
            if (!buttonElement) {
                console.error('‚ùå Sprinkler button element not found!');
                return;
            }
            
            // Visual feedback
            const originalBorder = buttonElement.style.border;
            buttonElement.style.border = '5px solid #ff0000';
            buttonElement.style.backgroundColor = '#ffebee';
            setTimeout(() => {
                buttonElement.style.border = originalBorder;
                buttonElement.style.backgroundColor = '';
            }, 300);
            
            // Toggle state
            window.sprinklerState = !window.sprinklerState;
            const sprinklerState = window.sprinklerState;
            
            // Update UI
            const statusElement = document.getElementById('sprinklerStatus');
            const powerElement = document.getElementById('sprinklerPower');
            const timeElement = document.getElementById('sprinklerTime');
            const indicatorElement = document.getElementById('sprinklerIndicator');
            
            if (statusElement && powerElement && timeElement) {
                if (sprinklerState) {
                    buttonElement.classList.add('active');
                    if (indicatorElement) indicatorElement.classList.add('active');
                    buttonElement.style.borderColor = '#28a745';
                    statusElement.textContent = 'ON';
                    statusElement.style.color = '#28a745';
                    statusElement.style.fontSize = '1.5rem';
                    statusElement.style.fontWeight = 'bold';
                    powerElement.textContent = '100W';
                    timeElement.textContent = new Date().toLocaleTimeString();
                } else {
                    buttonElement.classList.remove('active');
                    if (indicatorElement) indicatorElement.classList.remove('active');
                    buttonElement.style.borderColor = '#dc3545';
                    statusElement.textContent = 'OFF';
                    statusElement.style.color = '#dc3545';
                    statusElement.style.fontSize = '1.5rem';
                    statusElement.style.fontWeight = 'bold';
                    powerElement.textContent = '0W';
                    timeElement.textContent = 'Ready';
                }
            }
            
            // Force manual override by turning auto mode OFF
            if (typeof sendAutoMode === 'function') {
                sendAutoMode(false);
            }
            
            // Send MQTT command
            const command = sprinklerState ? 'ON' : 'OFF';
            const topic = 'greenhouse/actuators/sprinkler';
            const mqttClient = window.mqttClient;
            
            console.log('üì° Sending MQTT command:', { topic, command });
            
            if (mqttClient && mqttClient.connected) {
                try {
                    mqttClient.publish(topic, command, { qos: 1 });
                    console.log('‚úÖ MQTT command sent:', command);
                } catch (error) {
                    console.error('‚ùå MQTT Error:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è MQTT not connected');
            }
        };
        
        console.log('‚úÖ‚úÖ‚úÖ All actuator functions (Fan, Humidifier, Sprinkler) defined and ready!');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2ecc71;
    --primary-color-dark: #1f8f5d;
            --secondary-color: #27ae60;
    --dark-bg: #0f2642;
    --dark-bg-alt: #142d4f;
    --card-bg: #11223b;
    --surface-bg: #10253f;
    --surface-bg-light: #163554;
    --text-light: #f0f6ff;
    --text-muted: #a8b8d0;
    --warning: #f5a623;
            --danger: #e74c3c;
            --info: #3498db;
            --success: #2ecc71;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f2642 0%, #142d4f 55%, #0c1c33 100%);
            color: var(--text-light);
            min-height: 100vh;
            margin: 0;
            padding: 0;
    overflow-x: hidden;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body.nav-drawer-open {
    overflow: hidden;
        }

body.nav-drawer-open .page-content,
body.nav-drawer-open .dashboard-grid,
body.nav-drawer-open .fan-control-button,
body.nav-drawer-open .actuator-card {
    position: relative;
    z-index: 1;
}

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Navigation Bar */
        .navbar {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .menu-toggle {
            background: linear-gradient(135deg, #1f2c47, #17243a);
            border: 1px solid rgba(67, 97, 138, 0.4);
            border-radius: 10px;
            width: 46px;
            height: 46px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 24px rgba(8, 14, 26, 0.4);
        }

        .menu-toggle:hover,
        .menu-toggle:focus-visible {
            transform: translateY(-1px);
            border-color: rgba(46, 204, 113, 0.6);
            background: linear-gradient(135deg, rgba(31, 46, 71, 1), rgba(31, 143, 93, 0.45));
            box-shadow: 0 14px 30px rgba(46, 204, 113, 0.2);
        }

        .menu-toggle span {
            display: block;
            width: 22px;
            height: 2px;
            background: rgba(236, 244, 255, 0.85);
            border-radius: 2px;
            position: relative;
            transition: background 0.2s ease;
        }

        .menu-toggle span::before,
        .menu-toggle span::after {
            content: '';
            position: absolute;
            left: 0;
            width: 22px;
            height: 2px;
            background: rgba(236, 244, 255, 0.85);
            border-radius: 2px;
            transition: transform 0.2s ease, top 0.2s ease, bottom 0.2s ease;
        }

        .menu-toggle span::before {
            top: -6px;
        }

        .menu-toggle span::after {
            bottom: -6px;
        }

        .nav-drawer {
            position: fixed;
            top: 0;
            bottom: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: #14233a;
            border-right: 1px solid rgba(67, 97, 138, 0.45);
            padding: 30px 26px;
            box-shadow: 18px 0 45px rgba(6, 12, 24, 0.55);
            transition: left 0.3s ease;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            gap: 24px;
            color: #f6f9ff;
        }

        .nav-drawer.open {
            left: 0;
        }

        .nav-drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #f6f9ff;
            font-weight: 700;
            letter-spacing: 0.6px;
        }

        .drawer-close {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(170, 50, 40, 0.28));
            border: 1px solid rgba(231, 76, 60, 0.4);
            color: #ffaca3;
            font-size: 1.4rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            line-height: 1;
            display: grid;
            place-items: center;
            transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.2);
        }

        .drawer-close:hover,
        .drawer-close:focus-visible {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.3), rgba(170, 50, 40, 0.38));
            transform: rotate(90deg);
            box-shadow: 0 14px 26px rgba(231, 76, 60, 0.32);
        }

        .nav-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 14, 0.55);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1100;
        }

        .nav-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--success), #58b0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: var(--text-light);
            text-decoration: none;
            padding: 14px 16px;
            border-radius: 14px;
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease, border-color 0.25s ease;
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 1rem;
            background: linear-gradient(135deg, rgba(29, 63, 96, 0.92), rgba(21, 56, 90, 0.92));
            border: 1px solid rgba(73, 114, 162, 0.35);
            box-shadow: 0 12px 28px rgba(8, 14, 26, 0.45);
        }

        .nav-link:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.18), rgba(31, 143, 93, 0.35));
            border-color: rgba(46, 204, 113, 0.55);
            color: var(--text-light);
            box-shadow: 0 18px 36px rgba(46, 204, 113, 0.25);
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.3), rgba(31, 143, 93, 0.45));
            border-color: rgba(46, 204, 113, 0.75);
            color: var(--text-light);
            box-shadow: 0 20px 42px rgba(46, 204, 113, 0.32);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            background: linear-gradient(135deg, rgba(19, 42, 70, 0.92), rgba(14, 30, 52, 0.92));
            border: 1px solid rgba(67, 97, 138, 0.35);
            padding: 8px 14px;
            border-radius: 14px;
            box-shadow: 0 12px 26px rgba(3, 11, 26, 0.35);
        }

        .status-indicator-nav {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-indicator-nav.connected {
            background: var(--success);
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
        }

        .user-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, rgba(17, 40, 66, 0.95), rgba(24, 54, 88, 0.95));
            border: 1px solid rgba(67, 97, 138, 0.35);
            border-radius: 40px;
            padding: 8px 14px;
            color: var(--text-light);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 10px 24px rgba(8, 14, 26, 0.35);
        }

        .user-button:hover,
        .user-button:focus-visible {
            transform: translateY(-1px);
            border-color: rgba(46, 204, 113, 0.6);
            background: linear-gradient(135deg, rgba(26, 60, 90, 1), rgba(31, 143, 93, 0.45));
            box-shadow: 0 14px 30px rgba(46, 204, 113, 0.2);
        }

        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #1f8f5d);
            display: grid;
            place-items: center;
            font-weight: 700;
            letter-spacing: 0.3px;
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.35);
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .user-avatar .avatar-text {
            position: absolute;
            z-index: 1;
            font-size: 0.85rem;
        }

        .user-name {
            font-size: 0.88rem;
            color: #dfe4ea;
        }

        .user-caret {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .user-dropdown {
            position: absolute;
            top: 52px;
            right: 0;
            width: 190px;
            background: rgba(15, 22, 46, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            box-shadow: 0 18px 35px rgba(0, 0, 0, 0.35);
            padding: 8px;
            display: none;
            z-index: 15;
        }

        .user-dropdown.active {
            display: block;
        }

        .dropdown-item {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #ecf0f1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
        }

        .dropdown-item:hover,
        .dropdown-item:focus-visible {
            background: rgba(46, 204, 113, 0.18);
            color: #2ecc71;
            transform: translateX(3px);
        }

        .dropdown-divider {
            height: 1px;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.08);
        }

        .nav-link-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(15, 38, 64, 0.65);
            display: grid;
            place-items: center;
            font-size: 1.2rem;
            color: var(--success);
            transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
        }

        .nav-link-label {
            flex: 1;
            font-weight: 600;
            letter-spacing: 0.2px;
            color: inherit;
        }

        .nav-link.active .nav-link-icon,
        .nav-link:hover .nav-link-icon {
            background: rgba(46, 204, 113, 0.35);
            transform: scale(1.08);
            color: var(--text-light);
        }

        .nav-drawer-footer {
            margin-top: auto;
            padding-top: 18px;
            border-top: 1px solid rgba(73, 114, 162, 0.25);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-footer-button {
            width: 100%;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .nav-footer-button:focus-visible {
            outline: 2px solid rgba(46, 204, 113, 0.65);
            outline-offset: 4px;
        }

        /* Profile Section in Drawer - Always Visible */
        .drawer-profile-section {
            display: block;
            margin-bottom: 18px;
            padding-bottom: 18px;
        }

        .drawer-profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(29, 63, 96, 0.92), rgba(21, 56, 90, 0.92));
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(67, 97, 138, 0.35);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drawer-profile-header:hover {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.18), rgba(31, 143, 93, 0.35));
            border-color: rgba(46, 204, 113, 0.55);
            transform: translateY(-1px);
        }

        .drawer-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2ecc71, #1f8f5d);
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.35);
        }

        .drawer-user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .drawer-user-info {
            flex: 1;
            min-width: 0;
        }

        .drawer-user-name {
            font-weight: 600;
            font-size: 1rem;
            color: #f6f9ff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .drawer-profile-header:hover .drawer-user-name {
            color: #2ecc71;
        }

        .drawer-user-email {
            font-size: 0.85rem;
            color: rgba(246, 249, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .drawer-profile-menu {
            display: none; /* Removed - name is clickable instead */
        }

        .drawer-divider {
            height: 1px;
            background: rgba(73, 114, 162, 0.25);
            margin: 12px 0;
        }

        /* Profile section in drawer - hidden on desktop, shown on mobile */
        .drawer-profile-section {
            display: none;
        }
        
        /* Hide nav-drawer-footer on desktop - Settings and Logout are in main nav bar */
        .nav-drawer-footer {
            display: none;
        }
        
        /* Show profile section in drawer on mobile only */
        @media (max-width: 768px) {
            /* Reduce nav-drawer padding and gap on mobile */
            .nav-drawer {
                padding: 20px 20px;
                gap: 12px;
            }
            
            .drawer-profile-section {
                display: block !important;
                margin-bottom: 2px;
                padding-bottom: 2px;
            }
            
            /* Reduce drawer profile header margin on mobile */
            .drawer-profile-header {
                margin-bottom: 6px;
            }
            
            /* Hide user menu on mobile - profile is in drawer */
            .user-menu {
                display: none !important;
            }
            
            /* Spacing in nav-menu on mobile */
            .nav-menu {
                gap: 8px;
            }
            
            /* Reduce divider margin on mobile to bring Dashboard closer */
            .drawer-divider {
                margin: 2px 0;
            }
            
            /* Show nav-drawer-footer on mobile only */
            .nav-drawer-footer {
                display: flex;
                padding-top: 12px;
            }

            /* History Page - Mobile: Hide buttons, show dropdown */
            .time-range-selector {
                display: none !important;
            }

            .time-range-select-wrapper {
                display: block !important;
                width: 100%;
                margin-bottom: 12px;
                position: relative;
                z-index: 100 !important;
                pointer-events: auto !important;
                touch-action: manipulation !important;
            }

            .time-range-select-mobile {
                display: block !important;
                width: 100%;
                position: relative;
                z-index: 101 !important;
                pointer-events: auto !important;
                touch-action: manipulation !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }

            .history-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
                position: relative;
                z-index: 1;
                pointer-events: auto;
            }
        }

        /* Page Content */
        .page-content {
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        
        /* Ensure all card content is left-aligned */
        .card {
            text-align: left;
        }
        
        .card > * {
            text-align: left;
        }
        
        .card .card-header,
        .card .card-value,
        .card .card-unit,
        .card .card-title,
        .card .card-timestamp,
        .card .status-indicator,
        .card .sensor-info,
        .card .recommendation,
        .card .card-icon {
            text-align: left !important;
        }
        
        .clickable-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clickable-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--primary-color);
        }

        .clickable-card:active {
            transform: translateY(-2px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(46, 204, 113, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            margin-bottom: 18px;
            text-align: left;
        }
        
        .card-header .card-icon {
            flex-shrink: 0;
            text-align: left;
        }
        
        .card-header .card-title {
            flex: 1;
            text-align: left;
        }

        .card-icon {
            font-size: 2rem;
        }

        .card-title {
            font-size: 0.95rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            line-height: 1.4;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 12px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            text-align: left;
        }

        .card-unit {
            font-size: 1.05rem;
            color: var(--text-muted);
            font-weight: 500;
            line-height: 1.5;
        }

        .card-timestamp {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 12px;
            line-height: 1.5;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
            line-height: 1.4;
        }

        .status-good {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-warning {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .status-danger {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .recommendation {
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: var(--info);
            line-height: 1.6;
            text-align: left;
        }

        .about-section {
            margin-top: 40px;
            padding: 28px;
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(17, 40, 66, 0.95), rgba(20, 65, 97, 0.95));
            border: 1px solid rgba(73, 114, 162, 0.35);
            box-shadow: 0 24px 45px rgba(8, 14, 26, 0.45);
            display: grid;
            gap: 18px;
        }

        .about-section.highlight {
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.45), 0 28px 50px rgba(46, 204, 113, 0.25);
            transition: box-shadow 0.6s ease;
        }

        .about-section h2 {
            margin: 0;
            font-size: 1.6rem;
            color: var(--text-light);
            letter-spacing: 0.4px;
        }

        .about-section p {
            margin: 0;
            line-height: 1.7;
            color: var(--text-light);
            font-size: 1rem;
        }

        .about-section strong {
            color: var(--text-light);
        }

        .about-pill-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .about-pill {
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(46, 204, 113, 0.18);
            border: 1px solid rgba(46, 204, 113, 0.35);
            color: var(--text-light);
            font-size: 0.85rem;
            letter-spacing: 0.3px;
        }

        .sensor-info {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            line-height: 1.5;
            text-align: left;
        }

        .npk-status {
            font-size: 0.6rem;
            margin-top: 5px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-top: 18px;
        }

        .summary-grid.monitoring-summary {
            grid-template-columns: repeat(3, minmax(220px, 1fr));
        }

        .summary-grid.monitoring-summary .summary-item:nth-child(7),
        .summary-grid.monitoring-summary .summary-item:nth-child(8) {
            grid-column: 1 / -1;
        }

        @media (max-width: 1200px) {
            .summary-grid.monitoring-summary {
                grid-template-columns: repeat(2, minmax(220px, 1fr));
            }

            .summary-grid.monitoring-summary .summary-item:nth-child(7),
            .summary-grid.monitoring-summary .summary-item:nth-child(8) {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .summary-grid.monitoring-summary {
                grid-template-columns: 1fr;
            }
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 18px;
            background: linear-gradient(145deg, rgba(17, 40, 66, 0.92), rgba(21, 56, 90, 0.92));
            border-radius: 16px;
            border: 1px solid rgba(73, 114, 162, 0.3);
            box-shadow: 0 12px 22px rgba(8, 14, 26, 0.32);
        }

        .summary-status {
            font-size: 0.85rem;
            margin-top: 6px;
            padding: 4px 10px;
            border-radius: 14px;
            text-align: center;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: 1px solid transparent;
        }

        .summary-status.good {
            background: rgba(46, 204, 113, 0.18);
            color: var(--success);
            border-color: rgba(46, 204, 113, 0.35);
        }

        .summary-status.warning {
            background: rgba(245, 166, 35, 0.22);
            color: var(--warning);
            border-color: rgba(245, 166, 35, 0.35);
        }

        .summary-status.critical {
            background: rgba(231, 76, 60, 0.22);
            color: var(--danger);
            border-color: rgba(231, 76, 60, 0.35);
        }

        .summary-details {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 22px;
        }

        .summary-detail-item {
            background: linear-gradient(150deg, rgba(22, 52, 82, 0.92), rgba(14, 34, 60, 0.92));
            padding: 22px;
            border-radius: 16px;
            border: 1px solid rgba(73, 114, 162, 0.28);
            box-shadow: 0 14px 28px rgba(8, 14, 26, 0.34);
        }

        .summary-detail-item h4 {
            color: var(--text-light);
            margin-bottom: 12px;
            font-size: 1.05rem;
            letter-spacing: 0.3px;
        }

        .summary-detail-item p {
            margin: 6px 0;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .summary-icon {
            font-size: 1.6rem;
            display: grid;
            place-items: center;
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: rgba(46, 204, 113, 0.18);
            color: var(--success);
            box-shadow: 0 6px 14px rgba(46, 204, 113, 0.18);
        }

        .summary-content {
            flex: 1;
            display: grid;
            gap: 6px;
            text-align: left;
            justify-items: start;
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            letter-spacing: 0.2px;
        }

        .summary-value {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-light);
            width: 100%;
        }

        /* Additional Page Styles */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* History Page Styles */
        .time-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .time-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Mobile Time Range Dropdown */
        .time-range-select-mobile {
            display: none;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
            box-sizing: border-box;
            position: relative;
            z-index: 10;
            pointer-events: auto;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .time-range-select-mobile:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
        }

        .time-range-select-mobile:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .time-range-select-mobile option {
            background: rgba(22, 33, 62, 0.98);
            color: #ffffff;
            padding: 10px;
        }

        .time-range-select-wrapper {
            position: relative;
            width: 100%;
            z-index: 100;
            pointer-events: auto;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .export-btn {
            background: linear-gradient(135deg, var(--info), var(--primary-color));
            color: var(--text-light);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        /* Export Modal Styles */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .export-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .export-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2001;
            cursor: pointer;
        }

        .export-modal-content {
            position: relative;
            z-index: 2002;
            background: linear-gradient(135deg, rgba(22, 33, 62, 0.98), rgba(15, 23, 42, 0.98));
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-width: 95vw;
            box-sizing: border-box;
            overflow-x: hidden;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .export-modal.visible .export-modal-content {
            transform: scale(1);
        }

        .export-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .export-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }

        .export-modal-close {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
            color: #ffaca3;
            font-size: 24px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .export-modal-close:hover {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 0.6);
            transform: rotate(90deg);
        }

        .export-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Settings Page Styles */
        .settings-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-section h3 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 0.9rem;
            color: #e0e6ed;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 0.9rem;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .form-group select option {
            background: rgba(22, 33, 62, 0.98);
            color: #ffffff;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--success));
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
        }

        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .info-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 25px;
            height: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-light);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .info-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .info-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .info-modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .info-modal.visible .info-modal-content {
            transform: scale(1);
        }

        .info-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .info-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
            margin: 0;
        }

        .info-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .info-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .info-modal-body {
            color: var(--text-light);
            line-height: 1.6;
        }

        .info-modal-body h4 {
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .info-modal-body ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-modal-body li {
            margin: 5px 0;
        }

        .charts-section {
            margin-top: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text-light);
        }

        canvas {
            max-height: 300px;
        }

        .npk-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .npk-item {
            text-align: center;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(46, 204, 113, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .npk-card {
            text-align: center;
        }

        .npk-card .card-header {
            justify-content: center;
        }

        .npk-card .card-timestamp {
            text-align: center;
        }

        .npk-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .npk-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .settings-panel {
            margin-top: 30px;
            padding: 28px;
            border-radius: 20px;
            background: linear-gradient(145deg, rgba(17, 40, 66, 0.95), rgba(20, 65, 97, 0.95));
            border: 1px solid rgba(73, 114, 162, 0.35);
            box-shadow: 0 24px 45px rgba(8, 14, 26, 0.45);
            display: grid;
            gap: 22px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
        }

        .settings-title {
            margin: 0;
            font-size: 1.4rem;
            letter-spacing: 0.3px;
        }

        .settings-subtitle {
            margin: 6px 0 0;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .status-chip {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(67, 97, 138, 0.45);
            background: rgba(67, 97, 138, 0.2);
            color: var(--text-light);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status-chip.connected {
            border-color: rgba(46, 204, 113, 0.5);
            background: rgba(46, 204, 113, 0.18);
            color: var(--primary-color);
        }

        .settings-divider {
            height: 1px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 18px;
        }

        .settings-grid .full-span {
            grid-column: 1 / -1;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .input-group input,
        .input-group select {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(67, 97, 138, 0.35);
            background: rgba(15, 38, 64, 0.6);
            color: var(--text-light);
            font-size: 0.95rem;
            transition: border 0.2s ease, box-shadow 0.2s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: rgba(46, 204, 113, 0.6);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.25);
        }

        .settings-toggle-list {
            display: grid;
            gap: 14px;
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 14px 16px;
            border-radius: 14px;
            background: rgba(15, 38, 64, 0.65);
            border: 1px solid rgba(67, 97, 138, 0.32);
        }

        .settings-toggle small {
            display: block;
            margin-top: 4px;
            color: var(--text-muted);
        }

        .settings-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-end;
        }

        .outline-button {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid rgba(67, 97, 138, 0.45);
            background: transparent;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, border 0.2s ease;
        }

        .outline-button:hover,
        .outline-button:focus-visible {
            border-color: rgba(46, 204, 113, 0.6);
            transform: translateY(-1px);
        }

        .primary-button {
            padding: 10px 18px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: var(--bg-darker);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary-button:hover,
        .primary-button:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 16px 32px rgba(46, 204, 113, 0.25);
        }

        .connection-alert {
            padding: 14px 16px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(67, 97, 138, 0.25);
            border: 1px solid rgba(67, 97, 138, 0.4);
        }

        .connection-alert.connected {
            background: rgba(46, 204, 113, 0.12);
            border-color: rgba(46, 204, 113, 0.35);
            color: var(--primary-color);
        }

        .connection-alert.disconnected {
            background: rgba(231, 76, 60, 0.12);
            border-color: rgba(231, 76, 60, 0.35);
            color: var(--danger);
        }

        .connection-alert small {
            color: var(--text-muted);
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(67, 97, 138, 0.6);
            transition: .3s;
            border-radius: 999px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text-light);
            transition: .3s;
            border-radius: 50%;
        }

        .toggle input:checked + .slider {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
        }

        .toggle input:checked + .slider:before {
            transform: translateX(20px);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Fan Control Button Styles */
        .fan-control-button {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dc3545;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            cursor: pointer;
            user-select: none;
            color: #495057;
        }

        .fan-control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-color: #007bff;
        }

        .fan-control-button:active {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .fan-control-button.active {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        .fan-control-button.active .fan-indicator {
            background: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
        }

        .fan-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #dc3545;
            position: absolute;
            top: 15px;
            right: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .fan-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }

        .fan-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            transition: transform 0.3s ease;
        }

        .fan-control-button.active .fan-icon {
            transform: rotate(180deg);
        }

        .fan-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            text-align: center;
        }

        .fan-status {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
        }

        .fan-control-button.active .fan-status {
            color: #28a745;
        }

        .fan-power {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .fan-time {
            font-size: 0.9rem;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .npk-card {
                grid-column: span 2 !important;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .npk-card {
                grid-column: span 1 !important;
            }

            .npk-grid {
                grid-template-columns: 1fr;
            }

            .card-value {
                font-size: 2rem;
            }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.5s ease;
        }

        .alert-warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid var(--info);
            color: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <button class="menu-toggle" id="menuToggle" onclick="toggleNavDrawer()" aria-label="Open navigation">
                <span></span>
            </button>
            <div class="nav-brand">üå± Smart Farm Management</div>
            <div class="nav-right">
            <div class="nav-status">
                <div class="status-indicator-nav" id="navStatusDot"></div>
                <span id="navStatusText">Disconnected</span>
                </div>
                <div class="user-menu">
                    <button class="user-button" id="userButton" aria-haspopup="true" aria-expanded="false" onclick="toggleUserMenu(event)">
                        <span class="user-avatar" id="userAvatar" aria-hidden="true">U</span>
                        <span class="user-name" id="userName">Loading...</span>
                        <span class="user-caret" aria-hidden="true">&#9662;</span>
                    </button>
                    <div class="user-dropdown" id="userDropdown" role="menu" aria-labelledby="userButton">
                        <button class="dropdown-item" role="menuitem" onclick="openProfile()">Profile</button>
                        <button class="dropdown-item" role="menuitem" onclick="openSettings()">Settings</button>
                        <div class="dropdown-divider" aria-hidden="true"></div>
                        <button class="dropdown-item" role="menuitem" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-drawer" id="navDrawer" aria-hidden="true">
            <div class="nav-drawer-header">
                <span>Menu</span>
                <button class="drawer-close" onclick="closeNavDrawer()" aria-label="Close navigation">√ó</button>
            </div>
            
            <!-- Profile Section at Top - Mobile Only -->
            <div class="drawer-profile-section" id="drawerProfileSection">
                <div class="drawer-profile-header" onclick="closeNavDrawer(); openProfile();" style="cursor: pointer;">
                    <div class="drawer-user-avatar" id="drawerUserAvatar">U</div>
                    <div class="drawer-user-info">
                        <div class="drawer-user-name" id="drawerUserName" style="cursor: pointer;">Loading...</div>
                        <div class="drawer-user-email" id="drawerUserEmail"></div>
                    </div>
                </div>
            </div>
            
            <div class="drawer-divider"></div>
            
            <!-- Navigation Menu -->
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="homepage">
                        <span class="nav-link-icon">üè†</span>
                        <span class="nav-link-label">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="history">
                        <span class="nav-link-icon">üìä</span>
                        <span class="nav-link-label">History</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="actuators">
                        <span class="nav-link-icon">üéõÔ∏è</span>
                        <span class="nav-link-label">Actuators</span>
                    </a>
                </li>
            </ul>
            
            <div class="drawer-divider"></div>
            
            <!-- Settings and Logout at Bottom -->
            <div class="nav-drawer-footer">
                <button type="button" class="nav-link nav-footer-button" onclick="closeNavDrawer(); openSettings();">
                    <span class="nav-link-icon">‚öôÔ∏è</span>
                    <span class="nav-link-label">Settings</span>
                </button>
                <button type="button" class="nav-link nav-footer-button" onclick="closeNavDrawer(); logout();">
                    <span class="nav-link-icon">üö™</span>
                    <span class="nav-link-label">Logout</span>
                </button>
            </div>
        </div>
        <div class="nav-backdrop" id="navBackdrop" onclick="closeNavDrawer()" aria-hidden="true"></div>
    </nav>

    <!-- Page Content -->
    <div class="page-content">
        <!-- Page 1: Homepage - Real-time Monitoring -->
        <div id="homepage" class="page active">
            <div class="container">
                <header>
                    <h1>üå± Smart Greenhouse Dashboard</h1>
                </header>

                <div id="alerts"></div>

        <div class="dashboard-grid">
            <!-- Air Temperature Card -->
            <div class="card clickable-card" onclick="scrollToChart('tempHumidityChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('temperature')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üå°Ô∏è</div>
                    <div class="card-title">Air Temperature</div>
                </div>
                <div class="card-value" id="tempValue">--</div>
                <div class="card-unit">¬∞C</div>
                <div class="status-indicator" id="tempStatus">No data</div>
                <div class="sensor-info">Optimal: 18-25¬∞C<br>Critical: <10¬∞C or >35¬∞C</div>
                <div class="recommendation" id="tempRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="tempTime">No data</div>
            </div>

            <!-- Air Humidity Card -->
            <div class="card clickable-card" onclick="scrollToChart('tempHumidityChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('humidity')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üíß</div>
                    <div class="card-title">Air Humidity</div>
                </div>
                <div class="card-value" id="humidityValue">--</div>
                <div class="card-unit">%</div>
                <div class="status-indicator" id="humidityStatus">No data</div>
                <div class="sensor-info">Optimal: 60-80%<br>Critical: <40% or >90%</div>
                <div class="recommendation" id="humidityRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="humidityTime">No data</div>
            </div>

            <!-- Light Intensity Card -->
            <div class="card clickable-card" onclick="scrollToChart('lightChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('light')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üîÜ</div>
                    <div class="card-title">Light Intensity</div>
                </div>
                <div class="card-value" id="lightValue">--</div>
                <div class="card-unit">lux</div>
                <div class="status-indicator" id="lightStatus">No data</div>
                <div class="sensor-info">Optimal: 15,000-25,000 lux<br>Critical: <5,000 or >50,000 lux</div>
                <div class="recommendation" id="lightRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="lightTime">No data</div>
            </div>

            <!-- Soil Temperature Card -->
            <div class="card clickable-card" onclick="scrollToChart('soilTempChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('soilTemperature')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üå°Ô∏è</div>
                    <div class="card-title">Soil Temperature</div>
                </div>
                <div class="card-value" id="soilTempValue">--</div>
                <div class="card-unit">¬∞C</div>
                <div class="status-indicator" id="soilTempStatus">No data</div>
                <div class="sensor-info">Optimal: 20-28¬∞C<br>Critical: <15¬∞C or >35¬∞C</div>
                <div class="recommendation" id="soilTempRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="soilTempTime">No data</div>
            </div>

            <!-- Soil Humidity Card -->
            <div class="card clickable-card" onclick="scrollToChart('soilHumidityChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('soilHumidity')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üå±</div>
                    <div class="card-title">Soil Humidity</div>
                </div>
                <div class="card-value" id="soilHumidityValue">--</div>
                <div class="card-unit">%</div>
                <div class="status-indicator" id="soilHumidityStatus">No data</div>
                <div class="sensor-info">Optimal: 60-80%<br>Critical: <40% or >90%</div>
                <div class="recommendation" id="soilHumidityRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="soilHumidityTime">No data</div>
            </div>

            <!-- pH Level Card -->
            <div class="card clickable-card" onclick="scrollToChart('phChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('ph')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üß™</div>
                    <div class="card-title">Soil pH Level</div>
                </div>
                <div class="card-content">
                    <div class="card-value" id="phValue">--</div>
                    <div class="card-unit">pH</div>
                </div>
                <div class="status-indicator" id="phStatus">No data</div>
                <div class="sensor-info">Optimal: 6.0-7.0<br>Critical: <5.0 or >8.0</div>
                <div class="recommendation" id="phRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="phTime">No data</div>
            </div>

            <!-- NPK Card -->
            <div class="card npk-card clickable-card" style="grid-column: span 3;" onclick="scrollToChart('npkChart')">
                <button class="info-btn" onclick="event.stopPropagation(); showInfoModal('npk')">‚Ñπ</button>
                <div class="card-header">
                    <div class="card-icon">üåø</div>
                    <div class="card-title">Soil Nutrients (NPK)</div>
                </div>
                <div class="npk-grid">
                    <div class="npk-item">
                        <div class="npk-label">Nitrogen (N)</div>
                        <div class="npk-value" id="nitrogenValue">--</div>
                        <div class="card-unit">mg/kg</div>
                        <div class="status-indicator npk-status" id="nitrogenStatus">--</div>
                    </div>
                    <div class="npk-item">
                        <div class="npk-label">Phosphorus (P)</div>
                        <div class="npk-value" id="phosphorusValue">--</div>
                        <div class="card-unit">mg/kg</div>
                        <div class="status-indicator npk-status" id="phosphorusStatus">--</div>
                    </div>
                    <div class="npk-item">
                        <div class="npk-label">Potassium (K)</div>
                        <div class="npk-value" id="potassiumValue">--</div>
                        <div class="card-unit">mg/kg</div>
                        <div class="status-indicator npk-status" id="potassiumStatus">--</div>
                    </div>
                </div>
                <div class="sensor-info">Optimal: N>100, P>50, K>150 mg/kg<br>Critical: Any nutrient <30 mg/kg</div>
                <div class="recommendation" id="npkRecommendation" style="display: none;"></div>
                <div class="card-timestamp" id="npkTime">No data</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <!-- Temperature & Humidity Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Temperature & Humidity Trends</h3>
                <canvas id="tempHumidityChart"></canvas>
            </div>

            <!-- Light Intensity Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Light Intensity Over Time</h3>
                <canvas id="lightChart"></canvas>
            </div>

            <!-- Soil Monitoring Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Soil pH Level Over Time</h3>
                <canvas id="phChart"></canvas>
            </div>

            <!-- Soil Temperature Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Soil Temperature Over Time</h3>
                <canvas id="soilTempChart"></canvas>
            </div>

            <!-- Soil Humidity Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Soil Humidity Over Time</h3>
                <canvas id="soilHumidityChart"></canvas>
            </div>

            <!-- NPK Chart -->
            <div class="chart-container">
                <h3 class="chart-title">Soil Nutrients (NPK) Levels</h3>
                <canvas id="npkChart"></canvas>
            </div>
        </div>

        <!-- Summary Statistics Section -->
        <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">üìä Brassicaceae Monitoring Summary</h3>
                <div class="summary-grid monitoring-summary">
                    <div class="summary-item">
                        <div class="summary-icon">üå°Ô∏è</div>
                        <div class="summary-content">
                            <div class="summary-label">Air Temperature Range</div>
                            <div class="summary-value" id="tempRange">--¬∞C to --¬∞C</div>
                            <div class="summary-status" id="tempSummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üíß</div>
                        <div class="summary-content">
                            <div class="summary-label">Air Humidity Range</div>
                            <div class="summary-value" id="humidityRange">--% to --%</div>
                            <div class="summary-status" id="humiditySummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üîÜ</div>
                        <div class="summary-content">
                            <div class="summary-label">Light Intensity Range</div>
                            <div class="summary-value" id="lightRange">-- to -- lux</div>
                            <div class="summary-status" id="lightSummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üå°Ô∏è</div>
                        <div class="summary-content">
                            <div class="summary-label">Soil Temperature Range</div>
                            <div class="summary-value" id="soilTempRange">--¬∞C to --¬∞C</div>
                            <div class="summary-status" id="soilTempSummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üå±</div>
                        <div class="summary-content">
                            <div class="summary-label">Soil Moisture Range</div>
                            <div class="summary-value" id="soilHumidityRange">--% to --%</div>
                            <div class="summary-status" id="soilHumiditySummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üß™</div>
                        <div class="summary-content">
                            <div class="summary-label">Soil pH Range</div>
                            <div class="summary-value" id="phRange">-- to -- pH</div>
                            <div class="summary-status" id="phSummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üåø</div>
                        <div class="summary-content">
                            <div class="summary-label">Nutrient Status</div>
                            <div class="summary-value" id="nutrientStatus">N: -- P: -- K: --</div>
                            <div class="summary-status" id="nutrientSummaryStatus">No data</div>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon">üìà</div>
                        <div class="summary-content">
                            <div class="summary-label">Overall Health</div>
                            <div class="summary-value" id="overallHealth">Calculating...</div>
                            <div class="summary-status" id="overallHealthStatus">No data</div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Summary Information -->
                <div class="summary-details">
                    <div class="summary-detail-item">
                        <h4>üå± Brassicaceae Optimal Conditions</h4>
                        <p><strong>Temperature:</strong> 18-25¬∞C | <strong>Humidity:</strong> 60-80% | <strong>pH:</strong> 6.0-7.0</p>
                        <p><strong>Soil Temp:</strong> 20-28¬∞C | <strong>Soil Moisture:</strong> 60-80% | <strong>Light:</strong> 15,000-25,000 lux</p>
                    </div>
                    <div class="summary-detail-item">
                        <h4>üìä Current Status</h4>
                        <p id="currentStatus">Monitoring sensors for real-time data...</p>
                    </div>
                    <div class="summary-detail-item">
                        <h4>üéØ Recommendations</h4>
                        <p id="currentRecommendations">Awaiting sensor data for recommendations...</p>
                    </div>
                </div>
            </div>
        </div>

        <section class="about-section" id="aboutSection">
            <h2>About BrassiCore Greenhouse</h2>
            <p>
                We cultivate smarter Brassicaceae growth by uniting greenhouse automation, sensor intelligence,
                and data-driven decision support. Our platform empowers growers with live insights on climate,
                irrigation, and nutrient dynamics tailored specifically for mustasa, pechay, kale, and other
                cruciferous crops.
            </p>
            <div class="about-pill-row">
                <span class="about-pill">Smart Greenhouse Operations</span>
                <span class="about-pill">Brassicaceae-Centric Analytics</span>
                <span class="about-pill">IoT Actuator Control</span>
                <span class="about-pill">Sustainable Crop Innovation</span>
            </div>
        </section>

            </div>
        </div>

        <!-- Page 2: History & Analytics -->
        <div id="history" class="page">
            <div class="container">
                <div class="page-header">
                    <h1 class="page-title">üìä Historical Data & Analytics</h1>
                    <p class="page-subtitle">Analyze trends, export data, and track performance over time</p>
                </div>

                <!-- History Header with Export Button -->
                <div class="history-header">
                    <div class="time-range-selector">
                        <button class="time-btn active" data-range="1h">Last Hour</button>
                        <button class="time-btn" data-range="24h">Last 24 Hours</button>
                        <button class="time-btn" data-range="7d">Last 7 Days</button>
                        <button class="time-btn" data-range="30d">Last 30 Days</button>
                    </div>
                    <!-- Mobile Dropdown (hidden on desktop) -->
                    <div class="time-range-select-wrapper" onclick="event.stopPropagation();">
                        <select id="timeRangeSelect" class="time-range-select-mobile" onclick="event.stopPropagation();" onmousedown="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                            <option value="1h">Last Hour</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                    <button class="export-btn" onclick="showExportModal()">
                        <span>üì§</span> Export Data
                    </button>
                </div>

                <!-- Export Modal -->
                <div id="exportModal" class="export-modal">
                    <div class="export-modal-backdrop" onclick="hideExportModal()"></div>
                    <div class="export-modal-content" onclick="event.stopPropagation()">
                        <div class="export-modal-header">
                            <h3 class="export-modal-title">üì§ Data Export</h3>
                            <button class="export-modal-close" onclick="hideExportModal()" aria-label="Close export modal">√ó</button>
                        </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Export Format</label>
                            <select id="exportFormat">
                                <option value="csv">CSV (Excel Compatible)</option>
                                <option value="pdf">PDF Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                                <label>Start Date</label>
                            <input type="date" id="exportStartDate">
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                            <input type="date" id="exportEndDate">
                        </div>
                    </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn-primary" onclick="exportData()">Export Data</button>
                        <button class="btn-secondary" onclick="hideExportModal()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Individual Sensor Charts -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h3 class="chart-title">üå°Ô∏è Temperature History</h3>
                        <canvas id="historyTemperatureChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üíß Humidity History</h3>
                        <canvas id="historyHumidityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üí° Light Intensity History</h3>
                        <canvas id="historyLightChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üß™ pH Level History</h3>
                        <canvas id="historyPhChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üå± Soil Humidity History</h3>
                        <canvas id="historySoilHumidityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üå°Ô∏è Soil Temperature History</h3>
                        <canvas id="historySoilTemperatureChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üåø Nitrogen History</h3>
                        <canvas id="historyNitrogenChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üåø Phosphorus History</h3>
                        <canvas id="historyPhosphorusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">üåø Potassium History</h3>
                        <canvas id="historyPotassiumChart"></canvas>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="chart-container">
                    <h3 class="chart-title">üìä Performance Metrics</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-content">
                                <div class="summary-label">Average Temperature</div>
                                <div class="summary-value" id="avgTemp">--¬∞C</div>
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-content">
                                <div class="summary-label">Average Humidity</div>
                                <div class="summary-value" id="avgHumidity">--%</div>
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-content">
                                <div class="summary-label">Peak Light</div>
                                <div class="summary-value" id="peakLight">-- lux</div>
                            </div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-content">
                                <div class="summary-label">pH Stability</div>
                                <div class="summary-value" id="phStability">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Settings & Farmer Information -->
        <div id="settings" class="page">
            <div class="container">
                <div class="page-header">
                    <h1 class="page-title">‚öôÔ∏è Settings & Farm Management</h1>
                    <p class="page-subtitle">Configure sensors, manage crops, and customize your farm settings</p>
                </div>

                <!-- MQTT Connection Settings -->
                <div class="settings-section">
                    <h3>üîå MQTT Connection Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="settingsMqttBroker">MQTT Broker</label>
                            <input type="text" id="settingsMqttBroker" value="ws://broker.emqx.io:8083/mqtt" placeholder="ws://broker-ip:port/mqtt">
                        </div>
                        <div class="form-group">
                            <label for="settingsMqttUser">Username</label>
                            <input type="text" id="settingsMqttUser" value="myuser" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label for="settingsMqttPass">Password</label>
                            <input type="password" id="settingsMqttPass" value="*smart2025!" placeholder="Password">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="testConnection()">Test Connection</button>
                </div>

                <!-- Sensor Calibration & Thresholds -->
                <div class="settings-section">
                    <h3>üéØ Sensor Calibration & Thresholds</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Temperature Optimal Range</label>
                            <input type="number" id="tempMin" value="18" placeholder="Min ¬∞C">
                            <input type="number" id="tempMax" value="25" placeholder="Max ¬∞C">
                        </div>
                        <div class="form-group">
                            <label>Humidity Optimal Range</label>
                            <input type="number" id="humidityMin" value="60" placeholder="Min %">
                            <input type="number" id="humidityMax" value="80" placeholder="Max %">
                        </div>
                        <div class="form-group">
                            <label>pH Optimal Range</label>
                            <input type="number" id="phMin" value="6.0" step="0.1" placeholder="Min pH">
                            <input type="number" id="phMax" value="7.0" step="0.1" placeholder="Max pH">
                        </div>
                        <div class="form-group">
                            <label>Soil Humidity Optimal Range</label>
                            <input type="number" id="soilHumidityMin" value="60" placeholder="Min %">
                            <input type="number" id="soilHumidityMax" value="80" placeholder="Max %">
                        </div>
                        <div class="form-group">
                            <label>Soil Temperature Optimal Range</label>
                            <input type="number" id="soilTempMin" value="20" placeholder="Min ¬∞C">
                            <input type="number" id="soilTempMax" value="28" placeholder="Max ¬∞C">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveThresholds()">Save Thresholds</button>
                </div>

                <!-- Plant & Crop Management -->
                <div class="settings-section">
                    <h3>üå± Plant & Crop Management</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Current Crop</label>
                            <select id="currentCrop">
                                <option value="brassicaceae">Brassicaceae (Cabbage Family)</option>
                                <option value="tomato">Tomatoes</option>
                                <option value="lettuce">Lettuce</option>
                                <option value="pepper">Peppers</option>
                                <option value="herbs">Herbs</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Growth Stage</label>
                            <select id="growthStage">
                                <option value="seedling">Seedling</option>
                                <option value="vegetative">Vegetative</option>
                                <option value="flowering">Flowering</option>
                                <option value="fruiting">Fruiting</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Planting Date</label>
                            <input type="date" id="plantingDate">
                        </div>
                        <div class="form-group">
                            <label>Expected Harvest</label>
                            <input type="date" id="harvestDate">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveCropInfo()">Save Crop Information</button>
                </div>

                <!-- Automation Settings -->
                <div class="settings-section">
                    <h3>ü§ñ Automation Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Auto Watering</label>
                            <select id="autoWatering">
                                <option value="disabled">Disabled</option>
                                <option value="enabled">Enabled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Watering Threshold</label>
                            <input type="number" id="wateringThreshold" value="30" placeholder="Soil humidity %">
                        </div>
                        <div class="form-group">
                            <label>Lighting Schedule</label>
                            <input type="time" id="lightOn" value="06:00">
                            <input type="time" id="lightOff" value="18:00">
                        </div>
                        <div class="form-group">
                            <label>Ventilation Trigger</label>
                            <input type="number" id="ventilationTemp" value="28" placeholder="Temperature ¬∞C">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveAutomation()">Save Automation Settings</button>
                </div>

                <!-- Farm Information -->
                <div class="settings-section">
                    <h3>üè° Farm Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Greenhouse Size</label>
                            <input type="text" id="greenhouseSize" placeholder="e.g., 10m x 5m">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="farmLocation" placeholder="City, Country">
                        </div>
                        <div class="form-group">
                            <label>Equipment Inventory</label>
                            <textarea id="equipmentInventory" placeholder="List your sensors, pumps, lights, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="farmNotes" placeholder="Additional notes about your farm setup"></textarea>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveFarmInfo()">Save Farm Information</button>
                </div>
            </div>
        </div>

        <!-- Page 4: Actuators Control -->
        <div id="actuators" class="page">
            <div class="container">
                <div class="page-header">
                    <h1 class="page-title">üéõÔ∏è Actuator Control Center</h1>
                    <p class="page-subtitle">Control greenhouse equipment and monitor system status</p>
                </div>

                <!-- Actuator Controls Grid -->
                <div class="dashboard-grid">
                    <!-- Fan Control Button -->
                    <button type="button" class="fan-control-button" id="fanButton">
                        <div class="fan-indicator" id="fanIndicator"></div>
                        <div class="fan-header">
                            <div class="fan-icon">üå™Ô∏è</div>
                            <div class="fan-title">Industrial Fan</div>
                        </div>
                        <div class="fan-status" id="fanStatus">OFF</div>
                        <div class="fan-power" id="fanPower">0W</div>
                        <div class="fan-time" id="fanTime">Ready</div>
                    </button>
                    
                    <!-- Humidifier Control Button -->
                    <button type="button" class="fan-control-button" id="humidifierButton">
                        <div class="fan-indicator" id="humidifierIndicator"></div>
                        <div class="fan-header">
                            <div class="fan-icon">üí®</div>
                            <div class="fan-title">Humidifier</div>
                </div>
                        <div class="fan-status" id="humidifierStatus">OFF</div>
                        <div class="fan-power" id="humidifierPower">0W</div>
                        <div class="fan-time" id="humidifierTime">Ready</div>
                    </button>
                    
                    <!-- Sprinkler Control Button -->
                    <button type="button" class="fan-control-button" id="sprinklerButton">
                        <div class="fan-indicator" id="sprinklerIndicator"></div>
                        <div class="fan-header">
                            <div class="fan-icon">üíß</div>
                            <div class="fan-title">Sprinkler</div>
                        </div>
                        <div class="fan-status" id="sprinklerStatus">OFF</div>
                        <div class="fan-power" id="sprinklerPower">0W</div>
                        <div class="fan-time" id="sprinklerTime">Ready</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT Connection System
        // NOTE: MQTT connection is now handled by js/mqtt.js
        // This script only contains helper functions for UI updates
        
        // Duplicate MQTT connection removed - using js/mqtt.js instead
        // All MQTT connection code has been moved to js/mqtt.js
        // This prevents conflicts and ensures all sensors are handled correctly
        
        /*
        // REMOVED: Duplicate connectMQTT function (now in js/mqtt.js)
        function connectMQTT() {
            let broker = document.getElementById('mqttBroker').value.trim();
            const username = document.getElementById('mqttUser').value.trim();
            const password = document.getElementById('mqttPass').value;

            // Validate and fix broker URL if needed
            if (broker && !broker.endsWith('/mqtt') && broker.includes(':8083')) {
                console.log('‚ö†Ô∏è Broker URL missing /mqtt path, fixing...');
                broker = broker.replace(/:8083$/, ':8083/mqtt');
                document.getElementById('mqttBroker').value = broker;
                console.log('‚úÖ Fixed broker URL:', broker);
            }

            console.log('üîå Attempting MQTT connection...');
            console.log('üì° Broker:', broker);
            console.log('üë§ Username:', username || 'Not provided');
            console.log('üîê Password:', password ? '***' : 'Not provided');

            // Validate broker URL
            if (!broker) {
                console.error('‚ùå Broker URL is empty!');
                showAlert('Please enter a valid MQTT broker URL', 'warning');
                return;
            }

            if (!broker.startsWith('ws://') && !broker.startsWith('wss://')) {
                console.error('‚ùå Broker URL must start with ws:// or wss://');
                showAlert('Invalid broker URL format. Must start with ws:// or wss://', 'warning');
                return;
            }
            
            // For HTTPS deployments, prefer wss:// for security
            if (window.location.protocol === 'https:' && broker.startsWith('ws://')) {
                console.warn('‚ö†Ô∏è HTTPS page detected - consider using wss:// for secure connection');
                showAlert('‚ö†Ô∏è For HTTPS sites, consider using wss:// for secure WebSocket connection', 'warning');
            }

            // Save to localStorage
            localStorage.setItem('mqttBroker', broker);
            localStorage.setItem('mqttUser', username);
            localStorage.setItem('mqttPass', password);

            const options = {
                clean: true,
                connectTimeout: 4000,
                clientId: 'greenhouse_dashboard_' + Math.random().toString(16).substr(2, 8)
            };

            if (username && password) {
                options.username = username;
                options.password = password;
            }

            try {
                console.log('üöÄ Creating MQTT client with options:', {
                    broker: broker,
                    clientId: options.clientId,
                    hasAuth: !!(username && password),
                    connectTimeout: options.connectTimeout
                });

                mqttClient = mqtt.connect(broker, options);

                mqttClient.on('connect', () => {
                    console.log('‚úÖ Successfully connected to MQTT broker');
                    console.log('üîó Client ID:', mqttClient.options.clientId);
                    console.log('üåê Broker URL:', broker);
                    isConnected = true;
                    updateConnectionStatus(true);
                    
                    // Subscribe to all topics including fan status - matching Arduino ESP32 topics
                    const topics = [
                        'greenhouse/temperature',
                        'greenhouse/humidity', 
                        'greenhouse/light',
                        'greenhouse/soil_ph',           // Arduino publishes soil_ph
                        'greenhouse/soil_moisture',     // Arduino publishes soil_moisture
                        'greenhouse/soil_temperature',
                        'greenhouse/soil_ec',           // Optional: Electrical Conductivity
                        'greenhouse/nitrogen',
                        'greenhouse/phosphorus',
                        'greenhouse/potassium',
                        'greenhouse/actuators/fan_status',
                        'greenhouse/actuators/auto_mode_status',
                        'greenhouse/actuators/temp_threshold_status'
                    ];
                    
                    console.log('üìã Subscribing to topics:', topics);
                    topics.forEach(topic => {
                        mqttClient.subscribe(topic);
                        console.log(`üì• Subscribed to: ${topic}`);
                    });

                    showAlert('Successfully connected to MQTT broker', 'info');
                });

                mqttClient.on('error', (error) => {
                    console.error('‚ùå MQTT Connection Error:');
                    console.error('   Error Code:', error.code);
                    console.error('   Error Message:', error.message);
                    console.error('   Broker:', broker);
                    console.error('   Full Error:', error);
                    
                    updateConnectionStatus(false);
                    showAlert(`MQTT connection error: ${error.message}`, 'warning');
                });

                mqttClient.on('disconnect', () => {
                    console.log('üîå Disconnected from MQTT broker');
                    console.log('üìä Connection state:', mqttClient.connectionState);
                    updateConnectionStatus(false);
                });

                mqttClient.on('message', (topic, message) => {
                    console.log(`üì® Received MQTT message:`);
                    console.log(`   Topic: ${topic}`);
                    console.log(`   Message: ${message.toString()}`);
                    console.log(`   Timestamp: ${new Date().toISOString()}`);
                    
                    handleMessage(topic, message.toString());
                });

                mqttClient.on('reconnect', () => {
                    console.log('üîÑ MQTT client reconnecting...');
                    showAlert('Reconnecting to MQTT broker...', 'info');
                });

                mqttClient.on('offline', () => {
                    console.log('üì¥ MQTT client went offline');
                    updateConnectionStatus(false);
                    showAlert('MQTT connection lost - attempting to reconnect', 'warning');
                });

            } catch (error) {
                console.error('üí• Failed to create MQTT client:');
                console.error('   Error:', error);
                console.error('   Broker:', broker);
                console.error('   Stack trace:', error.stack);
                showAlert(`Failed to connect to MQTT broker: ${error.message}`, 'warning');
            }
        }
        // end of legacy removed block
        
        // REMOVED: Duplicate handleMQTTMessage function (now in js/mqtt.js)
        /*
        // Handle MQTT messages
        function handleMQTTMessage(topic, message) {
            switch(topic) {
                case 'greenhouse/actuators/fan_status':
                    console.log(`üéõÔ∏è Fan status update: ${message}`);
                    updateFanStatusFromMQTT(message === 'ON');
                    break;
                case 'greenhouse/temperature':
                    document.getElementById('tempValue').textContent = parseFloat(message).toFixed(1);
                    document.getElementById('tempTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/humidity':
                    document.getElementById('humidityValue').textContent = parseFloat(message).toFixed(1);
                    document.getElementById('humidityTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/light':
                    document.getElementById('lightValue').textContent = parseFloat(message).toFixed(1);
                    document.getElementById('lightTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/soil_ph':
                    document.getElementById('phValue').textContent = parseFloat(message).toFixed(1);
                    document.getElementById('phTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/soil_moisture':
                    document.getElementById('soilHumidityValue').textContent = parseFloat(message).toFixed(1);
                    document.getElementById('soilHumidityTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/soil_temperature':
                    document.getElementById('soilTempValue').textContent = parseFloat(message).toFixed(1);
                    document.getElementById('soilTempTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/nitrogen':
                    document.getElementById('nitrogenValue').textContent = Math.round(parseFloat(message));
                    document.getElementById('npkTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                    break;
                case 'greenhouse/phosphorus':
                    document.getElementById('phosphorusValue').textContent = Math.round(parseFloat(message));
                    break;
                case 'greenhouse/potassium':
                    document.getElementById('potassiumValue').textContent = Math.round(parseFloat(message));
                    break;
            }
        }
        // Legacy removed block end
        
        // REMOVED: Duplicate handleMessage function (now in js/mqtt.js)
        /*
        // Handle incoming MQTT messages
        function handleMessage(topic, message) {
            ... (removed duplicate code, now in js/mqtt.js)
        }
        */
        
        // Update fan status from MQTT
        function updateFanStatusFromMQTT(isOn) {
            console.log(`üîÑ Updating fan status from MQTT: ${isOn ? 'ON' : 'OFF'}`);
            
            // Update local state
            fanState = isOn;
            
            // Update visual indicators
            const buttonElement = document.getElementById('fanButton');
            const statusElement = document.getElementById('fanStatus');
            const powerElement = document.getElementById('fanPower');
            const timeElement = document.getElementById('fanTime');
            
            if (isOn) {
                buttonElement.classList.add('active');
                statusElement.textContent = 'ON';
                powerElement.textContent = '250W';
                timeElement.textContent = new Date().toLocaleTimeString();
            } else {
                buttonElement.classList.remove('active');
                statusElement.textContent = 'OFF';
                powerElement.textContent = '0W';
                timeElement.textContent = 'Ready';
            }
        }
        
        // Update actuator status from MQTT messages
        function updateActuatorStatusFromMQTT(actuatorType, status) {
            const isOn = (status === 'ON');
            const cardElement = document.getElementById(`${actuatorType}Card`);
            const indicatorElement = document.getElementById(`${actuatorType}Indicator`);
            const statusElement = document.getElementById(`${actuatorType}Status`);
            const powerElement = document.getElementById(`${actuatorType}Power`);
            const valueElement = document.getElementById(`${actuatorType}Value`);
            const timeElement = document.getElementById(`${actuatorType}Time`);
            
            // Update the state
            actuatorStates[actuatorType] = isOn;
            
            // Update visual indicators
            if (isOn) {
                cardElement.classList.add('active');
                indicatorElement.classList.add('active');
                statusElement.textContent = 'ONLINE';
                statusElement.className = 'status-indicator status-good';
                valueElement.textContent = 'ON';
                valueElement.style.color = 'var(--success)';
                valueElement.style.fontWeight = 'bold';
                powerElement.textContent = '250W';
                timeElement.textContent = new Date().toLocaleTimeString();
            } else {
                cardElement.classList.remove('active');
                indicatorElement.classList.remove('active');
                statusElement.textContent = 'OFF';
                statusElement.className = 'status-indicator';
                valueElement.textContent = 'OFF';
                valueElement.style.color = 'var(--text-muted)';
                valueElement.style.fontWeight = 'normal';
                powerElement.textContent = '0W';
                timeElement.textContent = 'Ready';
            }
            
            console.log(`üì° MQTT: ${actuatorType} status updated to ${status}`);
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('statusText');
            const connectionDiv = document.getElementById('connectionStatus');
            
            if (statusElement) {
                statusElement.textContent = connected ? '‚úÖ MQTT Connected' : '‚ùå MQTT Disconnected';
                statusElement.style.color = connected ? '#4CAF50' : '#f44336';
            }
            
            if (connectionDiv) {
                connectionDiv.style.backgroundColor = connected ? 'rgba(76, 175, 80, 0.1)' : 'rgba(244, 67, 54, 0.1)';
                connectionDiv.style.border = connected ? '1px solid #4CAF50' : '1px solid #f44336';
            }
        }
        
        // Actuator Control System
        let fanState = false;
        let humidifierState = false;
        let sprinklerState = false;
        
        // Expose state variables globally
        window.fanState = fanState;
        window.humidifierState = humidifierState;
        window.sprinklerState = sprinklerState;
        
        // Note: MQTT connection functions (connectMQTT, reconnectMQTT, checkConnectionStatus) 
        // are now handled by js/mqtt.js - they are made globally available there
        // Note: toggleFan, toggleHumidifier, and toggleSprinkler are defined in the <head> section
        
        // Send auto mode flag (true/false) to device
        function sendAutoMode(enabled) {
            const topic = 'greenhouse/actuators/auto_mode';
            const command = enabled ? 'ON' : 'OFF';
            const mqttClient = window.mqttClient;
            console.log(`üì° Sending MQTT command:`);
            console.log(`   Topic: ${topic}`);
            console.log(`   Command: ${command}`);
            if (mqttClient && mqttClient.connected) {
                try {
                    mqttClient.publish(topic, command, { qos: 1 });
                    console.log(`‚úÖ Auto mode ${command} command sent via MQTT`);
                } catch (error) {
                    console.error('‚ùå Failed to send auto mode command:', error);
                }
            }
        }
        
        // Show alert message
        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            if (!alertsDiv) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            alertsDiv.appendChild(alert);

            // Remove alert after 5 seconds
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.5s ease';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }
        
        // Note: toggleFan, toggleHumidifier, and toggleSprinkler are already defined 
        // in the <head> section as window.toggleFan, window.toggleHumidifier, window.toggleSprinkler
        
        // Verify functions are available
        console.log('‚úÖ‚úÖ‚úÖ Full Actuator functions exposed to window:', {
            toggleFan: typeof window.toggleFan,
            toggleHumidifier: typeof window.toggleHumidifier,
            toggleSprinkler: typeof window.toggleSprinkler,
            sendFanCommand: typeof window.sendFanCommand,
            isFullVersion: typeof window._toggleFanFull !== 'undefined'
        });
        
        // Test function to verify button setup - call from console: testFanButton()
        window.testFanButton = function() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üß™ TESTING FAN BUTTON SETUP');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            const btn = document.getElementById('fanButton');
            if (!btn) {
                console.error('‚ùå Fan button NOT FOUND in DOM!');
                alert('‚ùå Fan button NOT FOUND!');
                return false;
            }
            
            console.log('‚úÖ Button found:', btn);
            console.log('   ID:', btn.id);
            console.log('   Class:', btn.className);
            console.log('   Tag:', btn.tagName);
            console.log('   Is visible:', btn.offsetWidth > 0 && btn.offsetHeight > 0);
            console.log('   Has click listener:', btn._bound || 'Unknown');
            
            // Try to manually trigger click
            console.log('üñ±Ô∏è Manually triggering click event...');
            btn.click();
            
            console.log('‚úÖ Test completed - check for alerts and console messages');
            return true;
        };
        
        // Ensure buttons respond to clicks (bind programmatically)
        function bindActuatorButtons() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîóüîóüîó BINDING ACTUATOR BUTTONS... üîóüîóüîó');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Wait a bit for DOM to be fully ready
            setTimeout(() => {
                const fanBtn = document.getElementById('fanButton');
                const humBtn = document.getElementById('humidifierButton');
                const sprBtn = document.getElementById('sprinklerButton');
                
                console.log('üîç Button elements found:', {
                    fanButton: !!fanBtn,
                    humidifierButton: !!humBtn,
                    sprinklerButton: !!sprBtn
                });
                
                if (!fanBtn) {
                    console.error('‚ùå‚ùå‚ùå FAN BUTTON NOT FOUND IN DOM!');
                    alert('‚ùå CRITICAL: Fan button not found! Check HTML structure.');
                    return;
                }
                
                // Remove any existing listeners first
                if (fanBtn._bound) {
                    console.log('‚ö†Ô∏è Removing old listener from fan button');
                    fanBtn.removeEventListener('click', fanBtn._clickHandler);
                }
                
                // Create a persistent handler function
                fanBtn._clickHandler = function(e) {
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('üñ±Ô∏èüñ±Ô∏èüñ±Ô∏è CLICK EVENT DETECTED ON FAN BUTTON! üñ±Ô∏èüñ±Ô∏èüñ±Ô∏è');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('Event details:', {
                        type: e.type,
                        target: e.target.id || e.target.className,
                        currentTarget: e.currentTarget.id,
                        timestamp: new Date().toLocaleTimeString(),
                        buttonElement: !!fanBtn
                    });
                    
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    console.log('üéØ Calling toggleFan() function...');
                    try {
                        toggleFan();
                        console.log('‚úÖ toggleFan() function call completed');
                    } catch (error) {
                        console.error('‚ùå ERROR in toggleFan:', error);
                        alert('ERROR: ' + error.message);
                    }
                };
                
                // Add multiple event listeners with different methods
                // Method 1: Standard click
                fanBtn.addEventListener('click', fanBtn._clickHandler, true);
                
                // Method 2: Mouse down (earlier in event chain)
                fanBtn.addEventListener('mousedown', function(e) {
                    console.log('üñ±Ô∏è MOUSEDOWN on fan button');
                    e.preventDefault();
                }, true);
                
                // Method 3: Touch events for mobile
                fanBtn.addEventListener('touchstart', function(e) {
                    console.log('üëÜ TOUCHSTART on fan button');
                    e.preventDefault();
                    fanBtn._clickHandler(e);
                }, true);
                
                // Ensure button is clickable
                fanBtn.style.pointerEvents = 'auto';
                fanBtn.style.cursor = 'pointer';
                fanBtn.style.userSelect = 'none';
                
                // Remove any overlaying elements that might block clicks
                fanBtn.style.position = 'relative';
                // Note: z-index removed to prevent overlap with nav drawer
                
                fanBtn._bound = true;
                console.log('‚úÖ‚úÖ‚úÖ Fan button EVENT LISTENERS bound successfully!');
                console.log('   Button style:', {
                    pointerEvents: fanBtn.style.pointerEvents,
                    cursor: fanBtn.style.cursor,
                    display: window.getComputedStyle(fanBtn).display,
                    visibility: window.getComputedStyle(fanBtn).visibility
                });
                
                // Bind humidifier button
            if (humBtn && !humBtn._bound) {
                humBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üéØ Direct click on humidifierButton');
                    toggleHumidifier();
                });
                humBtn._bound = true;
                console.log('‚úÖ Humidifier button bound');
            }
            
                // Bind sprinkler button
            if (sprBtn && !sprBtn._bound) {
                sprBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üéØ Direct click on sprinklerButton');
                    toggleSprinkler();
                });
                sprBtn._bound = true;
                console.log('‚úÖ Sprinkler button bound');
            }

                // NOTE: Removed event delegation handlers - they were causing double-trigger issues
                // Direct button handlers are sufficient and more reliable
            
            console.log('üîó Button binding complete:', {
                fanBound: !!(fanBtn && fanBtn._bound),
                humidifierBound: !!(humBtn && humBtn._bound),
                    sprinklerBound: !!(sprBtn && sprBtn._bound)
            });
            }, 100);
        }
        // Bind buttons with multiple strategies
        console.log('üîß Setting up button binding...');
        console.log('   Document readyState:', document.readyState);
        
        // Strategy 1: DOMContentLoaded
        if (document.readyState === 'loading') {
            console.log('‚è≥ Waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('‚úÖ DOMContentLoaded fired');
                bindActuatorButtons();
            });
        } else {
            console.log('‚úÖ DOM already ready, binding immediately');
            bindActuatorButtons();
        }
        
        // Strategy 2: Window load (fallback)
        window.addEventListener('load', function() {
            console.log('‚úÖ Window load event fired');
            setTimeout(bindActuatorButtons, 500);
        });
        
        // Strategy 3: Immediate binding attempt (if DOM is ready)
        setTimeout(bindActuatorButtons, 1000);
        
        // NOTE: Removed duplicate global click handlers - they were causing double-trigger issues
        // The direct button handlers and event delegation in bindActuatorButtons() are sufficient

        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active class to clicked nav link
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            currentPage = pageId;
            
            // Initialize page-specific features
            if (pageId === 'history') {
                initializeHistoryPage();
            } else if (pageId === 'settings') {
                loadSettings();
            }
        }

        // Navigation event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    switchPage(pageId);
                });
            });
            
            // Check MQTT status every 5 seconds
            setInterval(checkMQTTStatus, 5000);
            
            // Initial status check
            setTimeout(checkMQTTStatus, 1000);
            
            // Verify fan card is clickable
            setTimeout(() => {
                const fanCard = document.getElementById('fanCard');
                if (fanCard) {
                    console.log('‚úÖ Fan card found and ready for clicks');
                } else {
                    console.log('‚ùå Fan card not found');
                }
            }, 1000);
        });

        // History Page Functions are in js/app.js

        // Export Modal Functions
        function showExportModal() {
            const modal = document.getElementById('exportModal');
            if (!modal) return;
            modal.classList.add('visible');
            document.body.style.overflow = 'hidden';
            
            // Set default dates (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const startDateInput = document.getElementById('exportStartDate');
            const endDateInput = document.getElementById('exportEndDate');
            if (startDateInput) startDateInput.value = lastWeek.toISOString().split('T')[0];
            if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
        }

        function hideExportModal() {
            const modal = document.getElementById('exportModal');
            if (!modal) return;
            modal.classList.remove('visible');
            document.body.style.overflow = '';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('exportModal');
                if (modal && modal.classList.contains('visible')) {
            hideExportModal();
        }
            }
        });

        // Data Export Functions - Use the async exportData from js/app.js
        // The exportData function is defined in js/app.js and uses buildExportDataset
        // This ensures consistent data export with proper metadata and actuator data

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Settings Page Functions
        function loadSettings() {
            // Load saved settings from localStorage
            const settings = JSON.parse(localStorage.getItem('farmSettings') || '{}');
            
            // Populate form fields
            if (settings.mqttBroker) document.getElementById('settingsMqttBroker').value = settings.mqttBroker;
            if (settings.mqttUser) document.getElementById('settingsMqttUser').value = settings.mqttUser;
            if (settings.mqttPass) document.getElementById('settingsMqttPass').value = settings.mqttPass;
            
            if (settings.tempMin) document.getElementById('tempMin').value = settings.tempMin;
            if (settings.tempMax) document.getElementById('tempMax').value = settings.tempMax;
            if (settings.humidityMin) document.getElementById('humidityMin').value = settings.humidityMin;
            if (settings.humidityMax) document.getElementById('humidityMax').value = settings.humidityMax;
            if (settings.phMin) document.getElementById('phMin').value = settings.phMin;
            if (settings.phMax) document.getElementById('phMax').value = settings.phMax;
            if (settings.soilHumidityMin) document.getElementById('soilHumidityMin').value = settings.soilHumidityMin;
            if (settings.soilHumidityMax) document.getElementById('soilHumidityMax').value = settings.soilHumidityMax;
            
            if (settings.currentCrop) document.getElementById('currentCrop').value = settings.currentCrop;
            if (settings.growthStage) document.getElementById('growthStage').value = settings.growthStage;
            if (settings.plantingDate) document.getElementById('plantingDate').value = settings.plantingDate;
            if (settings.harvestDate) document.getElementById('harvestDate').value = settings.harvestDate;
            
            if (settings.autoWatering) document.getElementById('autoWatering').value = settings.autoWatering;
            if (settings.wateringThreshold) document.getElementById('wateringThreshold').value = settings.wateringThreshold;
            if (settings.lightOn) document.getElementById('lightOn').value = settings.lightOn;
            if (settings.lightOff) document.getElementById('lightOff').value = settings.lightOff;
            if (settings.ventilationTemp) document.getElementById('ventilationTemp').value = settings.ventilationTemp;
            
            if (settings.greenhouseSize) document.getElementById('greenhouseSize').value = settings.greenhouseSize;
            if (settings.farmLocation) document.getElementById('farmLocation').value = settings.farmLocation;
            if (settings.equipmentInventory) document.getElementById('equipmentInventory').value = settings.equipmentInventory;
            if (settings.farmNotes) document.getElementById('farmNotes').value = settings.farmNotes;
        }

        function testConnection() {
            const broker = document.getElementById('settingsMqttBroker').value;
            const username = document.getElementById('settingsMqttUser').value;
            const password = document.getElementById('settingsMqttPass').value;
            
            // Test MQTT connection
            alert(`Testing connection to ${broker}...`);
            // In a real implementation, you'd test the MQTT connection here
        }

        function saveThresholds() {
            const settings = {
                tempMin: document.getElementById('tempMin').value,
                tempMax: document.getElementById('tempMax').value,
                humidityMin: document.getElementById('humidityMin').value,
                humidityMax: document.getElementById('humidityMax').value,
                phMin: document.getElementById('phMin').value,
                phMax: document.getElementById('phMax').value,
                soilHumidityMin: document.getElementById('soilHumidityMin').value,
                soilHumidityMax: document.getElementById('soilHumidityMax').value
            };
            
            localStorage.setItem('farmSettings', JSON.stringify(settings));
            alert('Thresholds saved successfully!');
        }

        function saveCropInfo() {
            const settings = JSON.parse(localStorage.getItem('farmSettings') || '{}');
            
            settings.currentCrop = document.getElementById('currentCrop').value;
            settings.growthStage = document.getElementById('growthStage').value;
            settings.plantingDate = document.getElementById('plantingDate').value;
            settings.harvestDate = document.getElementById('harvestDate').value;
            
            localStorage.setItem('farmSettings', JSON.stringify(settings));
            alert('Crop information saved successfully!');
        }

        function saveAutomation() {
            const settings = JSON.parse(localStorage.getItem('farmSettings') || '{}');
            
            settings.autoWatering = document.getElementById('autoWatering').value;
            settings.wateringThreshold = document.getElementById('wateringThreshold').value;
            settings.lightOn = document.getElementById('lightOn').value;
            settings.lightOff = document.getElementById('lightOff').value;
            settings.ventilationTemp = document.getElementById('ventilationTemp').value;
            
            localStorage.setItem('farmSettings', JSON.stringify(settings));
            alert('Automation settings saved successfully!');
        }

        function saveFarmInfo() {
            const settings = JSON.parse(localStorage.getItem('farmSettings') || '{}');
            
            settings.greenhouseSize = document.getElementById('greenhouseSize').value;
            settings.farmLocation = document.getElementById('farmLocation').value;
            settings.equipmentInventory = document.getElementById('equipmentInventory').value;
            settings.farmNotes = document.getElementById('farmNotes').value;
            
            localStorage.setItem('farmSettings', JSON.stringify(settings));
            alert('Farm information saved successfully!');
        }

        // Data storage for charts (keep last 20 data points)
        // NOTE: maxDataPoints and chartData are already declared in js/mqtt.js
        // These variables are available globally, so no need to redeclare them here

        // Actuator control system
        // NOTE: actuatorStates is already declared in js/app.js
        // This variable is available globally, so no need to redeclare it here

        // Enhanced summary statistics tracking
        // NOTE: summaryStats is already declared in js/mqtt.js
        // This variable is available globally, so no need to redeclare it here

        // NOTE: The following functions are already declared in js/mqtt.js and are available globally:
        // - updateSummaryStats
        // - updateSummaryDisplay
        // - updateRangeDisplay
        // - updateSummaryStatus
        // - updateOverallHealth
        // - updateCurrentStatus
        // - evaluateTemperature, evaluateHumidity, evaluateLight, evaluatePH, evaluateSoilHumidity, evaluateSoilTemperature, evaluateNPK
        // - updateStatus, updateRecommendation
        // No need to redeclare them here

        // NOTE: All chart variables (tempHumidityChart, lightChart, phChart, soilTempChart, soilHumidityChart, npkChart)
        // and the updateChartData() function are already declared and initialized in js/charts.js
        // Charts are initialized via the initializeCharts() function in js/charts.js
        // No need to redeclare them here

        // Add timestamp to chart
        function addTimestamp() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            chartData.labels.push(timeStr);
        }

        // Brassicaceae-specific thresholds for Lucban, Quezon Province
        // NOTE: brassicaceaeThresholds is already declared in js/mqtt.js
        // This variable is available globally, so no need to redeclare it here

        // NOTE: All evaluation functions and updateStatus/updateRecommendation are already declared in js/mqtt.js
        // They are available globally, so no need to redeclare them here

        // Handle incoming MQTT messages
        function handleMessage(topic, message) {
            const value = parseFloat(message);
            const now = new Date().toLocaleTimeString();

            switch(topic) {
                case 'greenhouse/temperature':
                    document.getElementById('tempValue').textContent = value.toFixed(1);
                    document.getElementById('tempTime').textContent = 'Updated: ' + now;
                    
                    // Update status and recommendations
                    updateStatus('tempStatus', evaluateTemperature(value));
                    updateRecommendation('tempRecommendation', 'temperature', value);
                    
                    // Update summary statistics
                    updateSummaryStats('temperature', value);
                    
                    // Add to chart only if it's a new timestamp
                    if (chartData.labels.length === 0 || chartData.labels[chartData.labels.length - 1] !== now) {
                        addTimestamp();
                    }
                    chartData.temperature.push(value);
                    break;

                case 'greenhouse/humidity':
                    document.getElementById('humidityValue').textContent = value.toFixed(1);
                    document.getElementById('humidityTime').textContent = 'Updated: ' + now;
                    
                    // Update status and recommendations
                    updateStatus('humidityStatus', evaluateHumidity(value));
                    updateRecommendation('humidityRecommendation', 'humidity', value);
                    
                    // Update summary statistics
                    updateSummaryStats('humidity', value);
                    
                    chartData.humidity.push(value);
                    break;

                case 'greenhouse/light':
                    document.getElementById('lightValue').textContent = value.toFixed(1);
                    document.getElementById('lightTime').textContent = 'Updated: ' + now;
                    
                    // Update status and recommendations
                    updateStatus('lightStatus', evaluateLight(value));
                    updateRecommendation('lightRecommendation', 'light', value);
                    
                    // Update summary statistics
                    updateSummaryStats('light', value);
                    
                    chartData.light.push(value);
                    break;

                case 'greenhouse/soil_ph':
                    document.getElementById('phValue').textContent = value.toFixed(1);
                    document.getElementById('phTime').textContent = 'Updated: ' + now;
                    
                    // Update status and recommendations
                    updateStatus('phStatus', evaluatePH(value));
                    updateRecommendation('phRecommendation', 'ph', value);
                    
                    // Update summary statistics
                    updateSummaryStats('ph', value);
                    
                    chartData.ph.push(value);
                    break;

                case 'greenhouse/soil_moisture':
                    document.getElementById('soilHumidityValue').textContent = value.toFixed(1);
                    document.getElementById('soilHumidityTime').textContent = 'Updated: ' + now;
                    
                    // Update status and recommendations
                    updateStatus('soilHumidityStatus', evaluateSoilHumidity(value));
                    updateRecommendation('soilHumidityRecommendation', 'soilHumidity', value);
                    
                    // Update summary statistics
                    updateSummaryStats('soilHumidity', value);
                    
                    chartData.soilHumidity.push(value);
                    break;

                case 'greenhouse/soil_temperature':
                    document.getElementById('soilTempValue').textContent = value.toFixed(1);
                    document.getElementById('soilTempTime').textContent = 'Updated: ' + now;
                    
                    // Update status and recommendations
                    updateStatus('soilTempStatus', evaluateSoilTemperature(value));
                    updateRecommendation('soilTempRecommendation', 'soilTemperature', value);
                    
                    chartData.soilTemperature.push(value);
                    break;

                case 'greenhouse/nitrogen':
                    document.getElementById('nitrogenValue').textContent = Math.round(value);
                    document.getElementById('npkTime').textContent = 'Updated: ' + now;
                    
                    // Update status
                    updateStatus('nitrogenStatus', evaluateNPK(value, 'N'));
                    
                    chartData.nitrogen.push(value);
                    break;

                case 'greenhouse/phosphorus':
                    document.getElementById('phosphorusValue').textContent = Math.round(value);
                    
                    // Update status
                    updateStatus('phosphorusStatus', evaluateNPK(value, 'P'));
                    
                    chartData.phosphorus.push(value);
                    break;

                case 'greenhouse/potassium':
                    document.getElementById('potassiumValue').textContent = Math.round(value);
                    
                    // Update status
                    updateStatus('potassiumStatus', evaluateNPK(value, 'K'));
                    
                    chartData.potassium.push(value);
                    break;

                case 'greenhouse/actuators/fan_status':
                    console.log(`üéõÔ∏è Fan status update: ${message}`);
                    updateActuatorStatusFromMQTT('fan', message);
                    break;

                default:
                    console.log(`‚ùì Unknown topic received: ${topic}`);
                    console.log(`   Message: ${message}`);
            }

            updateChartData();
        }
        
        // Scroll to specific chart
        function scrollToChart(chartId) {
            const chartElement = document.getElementById(chartId);
            if (chartElement) {
                chartElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                // Add a subtle highlight effect
                chartElement.style.border = '2px solid var(--primary-color)';
                chartElement.style.borderRadius = '15px';
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    chartElement.style.border = 'none';
                }, 2000);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const navStatusDot = document.getElementById('navStatusDot');
            const navStatusText = document.getElementById('navStatusText');
            const statusElement = document.getElementById('statusText');
            const connectionDiv = document.getElementById('connectionStatus');
            const statusChip = document.getElementById('mqttStatusChip');
            const statusTimestamp = document.getElementById('statusTimestamp');
            
            if (connected) {
                navStatusDot.classList.add('connected');
                navStatusText.textContent = 'Connected';
            } else {
                navStatusDot.classList.remove('connected');
                navStatusText.textContent = 'Disconnected';
            }
            
            // Update settings panel status
            if (statusElement) {
                statusElement.textContent = connected ? '‚úÖ MQTT Connected' : '‚ùå MQTT Disconnected';
            }
            
            if (connectionDiv) {
                connectionDiv.classList.toggle('connected', connected);
                connectionDiv.classList.toggle('disconnected', !connected);
            }

            if (statusChip) {
                statusChip.textContent = connected ? 'üü¢ Connected' : 'üî¥ Disconnected';
                statusChip.classList.toggle('connected', connected);
            }

            if (statusTimestamp) {
                const now = new Date();
                statusTimestamp.textContent = `Last checked: ${now.toLocaleString()}`;
            }
        }

        // Function to check MQTT connection status
        function checkMQTTStatus() {
            const isConnected = window.mqttClient && window.mqttClient.connected;
            updateConnectionStatus(isConnected);
            
            console.log('üîç MQTT Status Check:');
            console.log('- Client exists:', !!window.mqttClient);
            console.log('- Client connected:', isConnected);
            console.log('- Client state:', window.mqttClient ? window.mqttClient.connectionState : 'No client');
            
            return isConnected;
        }

        // Reconnect to MQTT
        function reconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
            }
            connectMQTT();
        }

        function saveMqttSettings() {
            const apiInput = document.getElementById('apiBaseUrl');
            const brokerInput = document.getElementById('mqttBroker');
            const userInput = document.getElementById('mqttUser');
            const passInput = document.getElementById('mqttPass');
            const clientIdInput = document.getElementById('mqttClientId');
            const autoReconnectInput = document.getElementById('toggleAutoReconnect');
            const connectionAlertsInput = document.getElementById('toggleConnectionAlerts');
            
            const broker = brokerInput ? brokerInput.value.trim() : '';
            const user = userInput ? userInput.value.trim() : '';
            const pass = passInput ? passInput.value : '';
            const clientId = clientIdInput ? clientIdInput.value.trim() : '';
            const autoReconnect = autoReconnectInput ? autoReconnectInput.checked : true;
            const connectionAlerts = connectionAlertsInput ? connectionAlertsInput.checked : true;

            let apiBase = apiInput ? apiInput.value.trim() : '';
            if (apiBase && typeof window.sanitizeApiBase === 'function') {
                apiBase = window.sanitizeApiBase(apiBase);
            }

            if (broker && !broker.includes('/mqtt')) {
                alert('Broker URL should include the /mqtt path (e.g., wss://host:port/mqtt).');
                return;
            }

            if (apiBase) {
                localStorage.setItem('apiBaseUrl', apiBase);
                if (apiInput) apiInput.value = apiBase;
            } else {
                localStorage.removeItem('apiBaseUrl');
            }

            if (broker) localStorage.setItem('mqttBroker', broker);
            if (user) localStorage.setItem('mqttUser', user); else localStorage.removeItem('mqttUser');
            if (pass) localStorage.setItem('mqttPass', pass); else localStorage.removeItem('mqttPass');
            if (clientId) localStorage.setItem('mqttClientId', clientId); else localStorage.removeItem('mqttClientId');

            localStorage.setItem('mqttAutoReconnect', autoReconnect ? '1' : '0');
            localStorage.setItem('mqttConnectionAlerts', connectionAlerts ? '1' : '0');

            showAlert('Connection settings saved. Reconnect to apply changes.', 'info');
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            alertsDiv.appendChild(alert);

            // Remove alert after 5 seconds
            setTimeout(() => {
                alert.style.animation = 'slideOut 0.5s ease';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        // Scroll to top function
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Show/hide scroll to top button based on scroll position
        function toggleScrollToTop() {
            const scrollButton = document.getElementById('scrollToTop');
            if (window.scrollY > 300) {
                scrollButton.classList.add('visible');
            } else {
                scrollButton.classList.remove('visible');
            }
        }

        // Load saved settings and connect on page load
        window.addEventListener('load', () => {
            // Clear old localStorage values if they don't have /mqtt path or use insecure protocol on HTTPS
            const savedBroker = localStorage.getItem('mqttBroker');
            if (savedBroker && (!savedBroker.includes('/mqtt') || 
                (window.location.protocol === 'https:' && savedBroker.startsWith('ws://')))) {
                console.log('üßπ Clearing old MQTT settings - updating to secure protocol');
                localStorage.removeItem('mqttBroker');
                localStorage.removeItem('mqttUser');
                localStorage.removeItem('mqttPass');
            }

            // Get MQTT input elements
            const mqttBrokerInput = document.getElementById('mqttBroker');
            const mqttUserInput = document.getElementById('mqttUser');
            const mqttPassInput = document.getElementById('mqttPass');
            const mqttClientIdInput = document.getElementById('mqttClientId');

            const currentBroker = savedBroker && savedBroker.includes('/mqtt') 
                ? savedBroker 
                : (mqttBrokerInput ? mqttBrokerInput.value : '');
            const savedUser = localStorage.getItem('mqttUser');
            const savedPass = localStorage.getItem('mqttPass');
            const savedClientId = localStorage.getItem('mqttClientId');
            const savedAutoReconnect = localStorage.getItem('mqttAutoReconnect');
            const savedConnectionAlerts = localStorage.getItem('mqttConnectionAlerts');

            // Set values from localStorage if they exist and are valid
            if (currentBroker && currentBroker.includes('/mqtt') && mqttBrokerInput) {
                mqttBrokerInput.value = currentBroker;
            }
            if (savedUser && mqttUserInput) {
                mqttUserInput.value = savedUser;
            }
            if (savedPass && mqttPassInput) {
                mqttPassInput.value = savedPass;
            }
            if (savedClientId && mqttClientIdInput) {
                mqttClientIdInput.value = savedClientId;
            }

            const autoReconnectToggle = document.getElementById('toggleAutoReconnect');
            if (autoReconnectToggle) {
                autoReconnectToggle.checked = savedAutoReconnect !== '0';
                autoReconnectToggle.addEventListener('change', () => {
                    localStorage.setItem('mqttAutoReconnect', autoReconnectToggle.checked ? '1' : '0');
                });
            }

            const connectionAlertsToggle = document.getElementById('toggleConnectionAlerts');
            if (connectionAlertsToggle) {
                connectionAlertsToggle.checked = savedConnectionAlerts !== '0';
                connectionAlertsToggle.addEventListener('change', () => {
                    localStorage.setItem('mqttConnectionAlerts', connectionAlertsToggle.checked ? '1' : '0');
                });
            }

            console.log('üìã Loading MQTT settings...');
            const mqttBrokerForLog = document.getElementById('mqttBroker');
            const mqttUserForLog = document.getElementById('mqttUser');
            const mqttPassForLog = document.getElementById('mqttPass');
            console.log('   Broker:', mqttBrokerForLog ? mqttBrokerForLog.value : 'Not found');
            console.log('   User:', mqttUserForLog ? (mqttUserForLog.value || 'Not set') : 'Not found');
            console.log('   Pass:', mqttPassForLog ? (mqttPassForLog.value ? '***' : 'Not set') : 'Not found');

            // Auto-connect after a short delay to ensure DOM is ready
            setTimeout(() => {
                console.log('‚è∞ Auto-connecting to MQTT...');
                
                // Load latest values from Firebase first (fallback if MQTT not connected)
                if (window.loadLatestValuesFromFirebase) {
                    console.log('üìä Loading latest values from Firebase...');
                    window.loadLatestValuesFromFirebase();
                }
                
                // If page is served over HTTPS and broker is using ws://, suggest wss://
                if (window.location.protocol === 'https:' && savedBroker && savedBroker.startsWith('ws://')) {
                    console.warn('‚ö†Ô∏è HTTPS page with insecure WebSocket - this may fail');
                    showAlert('‚ö†Ô∏è HTTPS page detected. Consider using wss:// broker URL for secure connection', 'warning');
                }
                
                if (window.connectMQTT) {
                    connectMQTT();
                }
            }, 500);
            
            // Set up periodic connection monitoring and fallback data loading
            setInterval(() => {
                if (mqttClient && !mqttClient.connected) {
                    console.log('üîÑ Periodic check: MQTT disconnected, attempting reconnection...');
                    if (window.reconnectMQTT) reconnectMQTT();
                    // If MQTT not connected, load from Firebase
                    setTimeout(() => {
                        if (!mqttClient || !mqttClient.connected) {
                            console.log('üìä MQTT still disconnected, loading latest from Firebase...');
                            if (window.loadLatestValuesFromFirebase) {
                                window.loadLatestValuesFromFirebase();
                            }
                        }
                    }, 2000);
                } else if (!mqttClient || !mqttClient.connected) {
                    // If MQTT never connected, load from Firebase periodically
                    console.log('üìä MQTT not connected, loading latest from Firebase...');
                    if (window.loadLatestValuesFromFirebase) {
                        window.loadLatestValuesFromFirebase();
                    }
                }
            }, 30000); // Check every 30 seconds
        });

        // Show info modal with sensor-specific information
        function showInfoModal(sensorType) {
            const modal = document.getElementById('infoModal');
            const title = document.getElementById('infoModalTitle');
            const body = document.getElementById('infoModalBody');
            
            const sensorInfo = getSensorInfo(sensorType);
            title.textContent = sensorInfo.title;
            body.innerHTML = sensorInfo.content;
            
            modal.classList.add('visible');
        }

        // Hide info modal
        function hideInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.remove('visible');
        }

        // Get sensor-specific information
        function getSensorInfo(sensorType) {
            const info = {
                temperature: {
                    title: 'üå°Ô∏è Air Temperature Sensor',
                    content: `
                        <p>The air temperature sensor monitors the ambient temperature inside your greenhouse, which is crucial for Brassicaceae cultivation.</p>
                        
                        <h4>Why It Matters for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Optimal Growth:</strong> Brassicaceae (cabbage family) thrive in cooler temperatures</li>
                            <li><strong>Bolting Prevention:</strong> High temperatures can cause premature flowering</li>
                            <li><strong>Quality Control:</strong> Proper temperature ensures better leaf development</li>
                        </ul>
                        
                        <h4>Optimal Ranges for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Good:</strong> 18-25¬∞C (64-77¬∞F)</li>
                            <li><strong>Warning:</strong> 15-30¬∞C (59-86¬∞F)</li>
                            <li><strong>Critical:</strong> Below 10¬∞C or above 35¬∞C</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Use ventilation systems during hot periods</li>
                            <li>Consider shade cloths in tropical climates</li>
                            <li>Monitor for temperature fluctuations</li>
                        </ul>
                    `
                },
                humidity: {
                    title: 'üíß Air Humidity Sensor',
                    content: `
                        <p>The air humidity sensor measures the moisture content in the air, which affects plant transpiration and disease susceptibility.</p>
                        
                        <h4>Why It Matters for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Disease Prevention:</strong> High humidity can lead to fungal diseases</li>
                            <li><strong>Water Management:</strong> Affects plant water uptake and transpiration</li>
                            <li><strong>Leaf Health:</strong> Proper humidity prevents leaf edge burn</li>
                        </ul>
                        
                        <h4>Optimal Ranges for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Good:</strong> 60-80% relative humidity</li>
                            <li><strong>Warning:</strong> 50-85% relative humidity</li>
                            <li><strong>Critical:</strong> Below 40% or above 90%</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Use dehumidifiers during high humidity periods</li>
                            <li>Ensure proper air circulation</li>
                            <li>Avoid overhead watering in humid conditions</li>
                        </ul>
                    `
                },
                light: {
                    title: 'üîÜ Light Intensity Sensor',
                    content: `
                        <p>The light sensor measures the intensity of light reaching your plants, which is essential for photosynthesis and growth.</p>
                        
                        <h4>Why It Matters for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Photosynthesis:</strong> Light drives energy production for growth</li>
                            <li><strong>Leaf Development:</strong> Proper light ensures healthy leaf formation</li>
                            <li><strong>Nutrient Production:</strong> Light affects vitamin and nutrient content</li>
                        </ul>
                        
                        <h4>Optimal Ranges for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Good:</strong> 15,000-25,000 lux</li>
                            <li><strong>Warning:</strong> 10,000-35,000 lux</li>
                            <li><strong>Critical:</strong> Below 5,000 or above 50,000 lux</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Use shade cloths during intense tropical sun</li>
                            <li>Supplement with LED grow lights if needed</li>
                            <li>Monitor light duration (12-16 hours optimal)</li>
                        </ul>
                    `
                },
                soilTemperature: {
                    title: 'üå°Ô∏è Soil Temperature Sensor',
                    content: `
                        <p>The soil temperature sensor monitors the temperature of the root zone, which affects nutrient uptake and root development.</p>
                        
                        <h4>Why It Matters for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Root Growth:</strong> Optimal soil temperature promotes healthy root development</li>
                            <li><strong>Nutrient Uptake:</strong> Temperature affects nutrient absorption efficiency</li>
                            <li><strong>Microbial Activity:</strong> Soil temperature influences beneficial soil organisms</li>
                        </ul>
                        
                        <h4>Optimal Ranges for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Good:</strong> 20-28¬∞C (68-82¬∞F)</li>
                            <li><strong>Warning:</strong> 18-30¬∞C (64-86¬∞F)</li>
                            <li><strong>Critical:</strong> Below 15¬∞C or above 35¬∞C</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Use mulch to regulate soil temperature</li>
                            <li>Consider raised beds for better temperature control</li>
                            <li>Monitor temperature fluctuations throughout the day</li>
                        </ul>
                    `
                },
                soilHumidity: {
                    title: 'üå± Soil Humidity Sensor',
                    content: `
                        <p>The soil humidity sensor measures the moisture content in the soil, which is critical for plant water uptake and root health.</p>
                        
                        <h4>Why It Matters for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Water Uptake:</strong> Proper soil moisture ensures adequate water supply</li>
                            <li><strong>Root Health:</strong> Prevents both drought stress and root rot</li>
                            <li><strong>Nutrient Transport:</strong> Water carries nutrients to plant roots</li>
                        </ul>
                        
                        <h4>Optimal Ranges for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Good:</strong> 60-80% field capacity</li>
                            <li><strong>Warning:</strong> 50-85% field capacity</li>
                            <li><strong>Critical:</strong> Below 40% or above 90%</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Implement drip irrigation for consistent moisture</li>
                            <li>Use well-draining soil to prevent waterlogging</li>
                            <li>Monitor soil moisture before watering</li>
                        </ul>
                    `
                },
                ph: {
                    title: 'üß™ Soil pH Sensor',
                    content: `
                        <p>The soil pH sensor measures the acidity or alkalinity of your soil, which affects nutrient availability and plant health.</p>
                        
                        <h4>Why It Matters for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Nutrient Availability:</strong> pH affects how well plants can absorb nutrients</li>
                            <li><strong>Root Health:</strong> Extreme pH can damage root systems</li>
                            <li><strong>Disease Resistance:</strong> Proper pH helps prevent soil-borne diseases</li>
                        </ul>
                        
                        <h4>Optimal Ranges for Brassicaceae:</h4>
                        <ul>
                            <li><strong>Good:</strong> 6.0-7.0 (slightly acidic to neutral)</li>
                            <li><strong>Warning:</strong> 5.5-7.5</li>
                            <li><strong>Critical:</strong> Below 5.0 or above 8.0</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Add lime to raise pH if too acidic</li>
                            <li>Add sulfur to lower pH if too alkaline</li>
                            <li>Test soil pH regularly, especially in tropical climates</li>
                        </ul>
                    `
                },
                npk: {
                    title: 'üåø Soil Nutrients (NPK) Sensor',
                    content: `
                        <p>The NPK sensor measures the levels of essential macronutrients: Nitrogen (N), Phosphorus (P), and Potassium (K) in your soil.</p>
                        
                        <h4>Why Each Nutrient Matters for Brassicaceae:</h4>
                        
                        <h4>Nitrogen (N):</h4>
                        <ul>
                            <li><strong>Leaf Growth:</strong> Essential for healthy leaf development</li>
                            <li><strong>Chlorophyll Production:</strong> Needed for photosynthesis</li>
                            <li><strong>Optimal Range:</strong> Above 100 mg/kg</li>
                        </ul>
                        
                        <h4>Phosphorus (P):</h4>
                        <ul>
                            <li><strong>Root Development:</strong> Promotes strong root systems</li>
                            <li><strong>Energy Transfer:</strong> Essential for energy storage and transfer</li>
                            <li><strong>Optimal Range:</strong> Above 50 mg/kg</li>
                        </ul>
                        
                        <h4>Potassium (K):</h4>
                        <ul>
                            <li><strong>Disease Resistance:</strong> Improves plant immunity</li>
                            <li><strong>Water Regulation:</strong> Helps with water uptake and retention</li>
                            <li><strong>Optimal Range:</strong> Above 150 mg/kg</li>
                        </ul>
                        
                        <h4>Management Tips:</h4>
                        <ul>
                            <li>Use balanced fertilizers for Brassicaceae</li>
                            <li>Monitor nutrient levels throughout growing season</li>
                            <li>Consider organic amendments for long-term soil health</li>
                        </ul>
                    `
                }
            };
            
            return info[sensorType] || {
                title: 'Sensor Information',
                content: '<p>Information not available for this sensor.</p>'
            };
        }

        // Add scroll event listener for scroll-to-top button
        window.addEventListener('scroll', toggleScrollToTop);
    </script>

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()">
        ‚Üë
    </button>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h3 class="info-modal-title" id="infoModalTitle">Sensor Information</h3>
                <button class="info-modal-close" onclick="hideInfoModal()">√ó</button>
            </div>
            <div class="info-modal-body" id="infoModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        (async function () {
            const AUTH_KEY = 'sg_auth_token';
            const AUTH_EXPIRY_KEY = 'sg_auth_expires';
            const API_BASE = 'https://maseed.onrender.com/api';
            const token = localStorage.getItem(AUTH_KEY);
            const expiry = parseInt(localStorage.getItem(AUTH_EXPIRY_KEY), 10);

            // Check if token exists and hasn't expired
            if (!token || Number.isNaN(expiry) || Date.now() > expiry) {
                localStorage.removeItem(AUTH_KEY);
                localStorage.removeItem(AUTH_EXPIRY_KEY);
                window.location.replace('login.html');
                return;
            }

            // Verify token with backend
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem(AUTH_KEY);
                    localStorage.removeItem(AUTH_EXPIRY_KEY);
                    window.location.replace('login.html');
                    return;
                }

                // Token is valid
                window.SG_AUTH = { AUTH_KEY, AUTH_EXPIRY_KEY };
                
                // Load user profile to display name
                loadUserProfile();
            } catch (error) {
                console.error('Auth verification error:', error);
                // Allow access if server is down (graceful degradation)
                window.SG_AUTH = { AUTH_KEY, AUTH_EXPIRY_KEY };
                // Still try to load profile
                loadUserProfile();
            }
        })();

        // Load user profile and update UI
        async function loadUserProfile() {
            const API_BASE = 'https://maseed.onrender.com/api';
            const AUTH_KEY = 'sg_auth_token';
            const token = localStorage.getItem(AUTH_KEY);
            
            if (!token) {
                updateUserDisplay('User', 'U', null, null);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    cache: 'no-cache' // Always fetch fresh data
                });

                if (response.ok) {
                    const profile = await response.json();
                    const displayName = profile.fullName || profile.displayName || profile.email?.split('@')[0] || 'User';
                    const nameForInitials = profile.fullName || profile.displayName || profile.email?.split('@')[0] || 'U';
                    const initials = nameForInitials
                        .split(' ')
                        .map(name => name[0])
                        .join('')
                        .substring(0, 2)
                        .toUpperCase();
                    updateUserDisplay(displayName, initials, profile.photoUrl, profile.email);
                } else {
                    updateUserDisplay('User', 'U', null, null);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                updateUserDisplay('User', 'U', null, null);
            }
        }

        function updateUserDisplay(name, initials, photoUrl, email) {
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const drawerUserNameEl = document.getElementById('drawerUserName');
            const drawerUserAvatarEl = document.getElementById('drawerUserAvatar');
            const drawerUserEmailEl = document.getElementById('drawerUserEmail');
            
            // Update nav bar profile
            if (userNameEl) {
                userNameEl.textContent = name;
            }
            
            if (userAvatarEl) {
                // Clear existing content
                userAvatarEl.innerHTML = '';
                
                if (photoUrl) {
                    // Display photo
                    const img = document.createElement('img');
                    img.src = photoUrl;
                    img.alt = name;
                    img.onerror = function() {
                        // If image fails to load, show initials
                        showAvatarInitials(userAvatarEl, initials);
                    };
                    userAvatarEl.appendChild(img);
                } else {
                    // Show initials
                    showAvatarInitials(userAvatarEl, initials);
                }
            }
            
            // Update drawer profile section
            if (drawerUserNameEl) {
                drawerUserNameEl.textContent = name;
            }
            
            if (drawerUserAvatarEl) {
                drawerUserAvatarEl.innerHTML = '';
                if (photoUrl) {
                    const img = document.createElement('img');
                    img.src = photoUrl;
                    img.alt = name;
                    img.onerror = function() {
                        showAvatarInitials(drawerUserAvatarEl, initials);
                    };
                    drawerUserAvatarEl.appendChild(img);
                } else {
                    showAvatarInitials(drawerUserAvatarEl, initials);
                }
            }
            
            // Update email in drawer
            if (drawerUserEmailEl) {
                if (email) {
                    drawerUserEmailEl.textContent = email;
                    drawerUserEmailEl.style.display = 'block';
                } else {
                    drawerUserEmailEl.style.display = 'none';
                }
            }
        }

        function showAvatarInitials(avatarEl, initials) {
            const textEl = document.createElement('span');
            textEl.className = 'avatar-text';
            textEl.textContent = initials;
            avatarEl.appendChild(textEl);
        }

        // Refresh user profile when page becomes visible (e.g., returning from profile page)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, refresh user profile
                loadUserProfile();
            }
        });

        // Also refresh when window gains focus (alternative trigger)
        window.addEventListener('focus', function() {
            loadUserProfile();
        });

        // Listen for profile updates from other tabs/windows
        window.addEventListener('storage', function(e) {
            if (e.key === 'sg_profile_updated') {
                // Profile was updated in another tab, refresh
                loadUserProfile();
            }
        });

        // Check for profile updates on page load
        window.addEventListener('load', function() {
            const lastUpdate = localStorage.getItem('sg_profile_updated');
            if (lastUpdate) {
                // Profile was recently updated, refresh
                loadUserProfile();
            }
        });

        const userDropdown = document.getElementById('userDropdown');
        const userButton = document.getElementById('userButton');
        const navDrawer = document.getElementById('navDrawer');
        const navBackdrop = document.getElementById('navBackdrop');
        const menuToggleButton = document.getElementById('menuToggle');

        function toggleUserMenu(event) {
            event.stopPropagation();
            if (!userDropdown || !userButton) return;
            const isActive = userDropdown.classList.toggle('active');
            userButton.setAttribute('aria-expanded', String(isActive));
            if (isActive) {
                const firstItem = userDropdown.querySelector('.dropdown-item');
                if (firstItem) {
                    firstItem.focus();
                }
            }
        }

        function closeUserMenu() {
            if (!userDropdown || !userButton) return;
            userDropdown.classList.remove('active');
            userButton.setAttribute('aria-expanded', 'false');
        }

        function openNavDrawer() {
            if (!navDrawer || !navBackdrop) return;
            navDrawer.classList.add('open');
            navDrawer.setAttribute('aria-hidden', 'false');
            navBackdrop.classList.add('active');
            navBackdrop.setAttribute('aria-hidden', 'false');
            document.body.classList.add('nav-drawer-open');
            if (menuToggleButton) {
                menuToggleButton.setAttribute('aria-expanded', 'true');
            }
            const firstLink = navDrawer.querySelector('.nav-link');
            if (firstLink) {
                firstLink.focus();
            }
        }

        function closeNavDrawer() {
            if (!navDrawer || !navBackdrop) return;
            
            // Blur any focused elements inside the drawer before hiding it
            // This prevents accessibility warnings about aria-hidden on focused elements
            const activeElement = document.activeElement;
            if (activeElement && navDrawer.contains(activeElement)) {
                activeElement.blur();
            }
            
            navDrawer.classList.remove('open');
            navDrawer.setAttribute('aria-hidden', 'true');
            navBackdrop.classList.remove('active');
            navBackdrop.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('nav-drawer-open');
            if (menuToggleButton) {
                menuToggleButton.setAttribute('aria-expanded', 'false');
                // Return focus to the menu toggle button when drawer closes
                menuToggleButton.focus();
            }
        }

        function toggleNavDrawer() {
            if (!navDrawer) return;
            if (navDrawer.classList.contains('open')) {
                closeNavDrawer();
                if (menuToggleButton) {
                    menuToggleButton.focus();
                }
            } else {
                openNavDrawer();
            }
        }

        function handleUserMenuClickOutside(event) {
            if (!userDropdown || !userButton) return;
            if (!userDropdown.contains(event.target) && !userButton.contains(event.target)) {
                closeUserMenu();
            }
            if (navDrawer && !navDrawer.contains(event.target) && menuToggleButton && !menuToggleButton.contains(event.target)) {
                closeNavDrawer();
            }
        }

        function handleGlobalKeydown(event) {
            if (event.key === 'Escape') {
                let focusTarget = null;
                if (userDropdown && userDropdown.classList.contains('active')) {
                    closeUserMenu();
                    focusTarget = userButton || focusTarget;
                }
                if (navDrawer && navDrawer.classList.contains('open')) {
                    closeNavDrawer();
                    focusTarget = menuToggleButton || focusTarget;
                }
                if (focusTarget) {
                    focusTarget.focus();
                }
            }
        }

        function openAboutSection() {
            closeNavDrawer();
            const aboutSection = document.getElementById('aboutSection');
            if (aboutSection) {
                aboutSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                aboutSection.classList.add('highlight');
            setTimeout(() => {
                    aboutSection.classList.remove('highlight');
                }, 2000);
            }
        }

        function openProfile() {
            closeUserMenu();
            window.location.href = 'profile.html';
        }

        function openSettings() {
            closeUserMenu();
            window.location.href = 'settings.html';
        }

        function logout() {
            const AUTH_KEY = window.SG_AUTH ? window.SG_AUTH.AUTH_KEY : 'sg_auth_token';
            const AUTH_EXPIRY_KEY = window.SG_AUTH ? window.SG_AUTH.AUTH_EXPIRY_KEY : 'sg_auth_expires';
            localStorage.removeItem(AUTH_KEY);
            localStorage.removeItem(AUTH_EXPIRY_KEY);
            window.location.replace('login.html');
        }

        document.addEventListener('click', handleUserMenuClickOutside);
        document.addEventListener('keydown', handleGlobalKeydown);
    </script>

    <!-- Responsive Utilities -->
    <script>
        // Prevent zoom on input focus (iOS)
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth <= 768) {
                        const viewport = document.querySelector('meta[name="viewport"]');
                        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                });
                
                input.addEventListener('blur', function() {
                    const viewport = document.querySelector('meta[name="viewport"]');
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
                });
            });
        });

        // Responsive utilities
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function isTablet() {
            return window.innerWidth > 768 && window.innerWidth <= 1024;
        }

        function isDesktop() {
            return window.innerWidth > 1024;
        }

        // Add loading states for better UX
        function showLoading(element) {
            if (element) {
                element.style.opacity = '0.6';
                element.style.pointerEvents = 'none';
            }
        }

        function hideLoading(element) {
            if (element) {
                element.style.opacity = '1';
                element.style.pointerEvents = 'auto';
            }
        }

        // Enhanced button interactions for mobile
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });
    </script>
</body>
</html>

